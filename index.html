<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro</title>
<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;}
.top-bar{background:#0d6efd;padding:10px;color:white;display:flex;justify-content:space-between;align-items:center;font-size:14px}
.top-bar button{background:white;color:#0d6efd;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;margin-left:5px}
.chat{max-width:700px;margin:auto;padding:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px;position:relative;animation:fade .3s}
.msg small{color:#aaa;font-size:12px}
.msg .actions{margin-top:5px}
.reactions span{margin-left:8px;cursor:pointer}
input,select,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
.reply-box{background:#333;padding:5px;margin-bottom:5px;border-radius:5px;font-size:12px;color:#fff3cd}
#typingStatus{font-size:12px;color:#aaa;margin-bottom:5px}
#onlineUsers{font-size:12px;color:#0f0;margin-bottom:5px}
#messagesPublic, #messagesPrivate{max-height:300px;overflow-y:auto;padding:5px;border-radius:5px;margin-bottom:10px;}
#messagesPublic{background:#111;}
#messagesPrivate{background:#222;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<div class="top-bar">
  <span>ğŸ‘¤ <strong id="displayName"></strong></span>
  <div>
    <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
  </div>
</div>

<div class="chat">
  <div id="onlineUsers"></div>
  <div id="typingStatus"></div>
  <div id="replyBox"></div>

  <input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
  <select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
  <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
  <div id="messagesPublic"></div>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ</h3>
  <div id="messagesPrivate"></div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

let userId = localStorage.getItem("userId");
if(!userId){
  userId = Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ± Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³";
  localStorage.setItem("chatName", username);
}
document.getElementById("displayName").innerText = username;

// Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù†
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload", ()=>usersRef.doc(userId).update({online:false}));

// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();

// ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯
document.getElementById("text").addEventListener("input", ()=>{
  typingRef.doc(userId).set({name:username});
  setTimeout(()=>typingRef.doc(userId).delete().catch(()=>{}),1500);
});
onSnapshotTyping = typingRef.onSnapshot(snap=>{
  let names=[];
  snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// Ø¢Ù†Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§
function renderOnline(){
  usersRef.where("online","==",true).get().then(snap=>{
    let html="";
    snap.forEach(u=>{html+=u.data().name+" "});
    document.getElementById("onlineUsers").innerText="Ø¢Ù†Ù„Ø§ÛŒÙ†: "+html;
  });
}
setInterval(renderOnline,2000);

// Ø±ÛŒÙ¾Ù„Ø§ÛŒ
let replyTo = null;
function setReply(id){ replyTo=id; document.getElementById("replyBox").innerText="Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ù¾ÛŒØ§Ù…..."; }

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(){
  const text=document.getElementById("text").value.trim();
  const receiverId=document.getElementById("receiver").value || null;
  if(!text) return alert("Ù¾ÛŒØ§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

  messagesRef.add({
    name:username,
    text,
    userId,
    receiverId,
    reactions:{heart:[],like:[]},
    replyTo,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("text").value="";
  replyTo=null;
  document.getElementById("replyBox").innerText="";
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
let firstLoad=true;
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  const boxPublic=document.getElementById("messagesPublic");
  const boxPrivate=document.getElementById("messagesPrivate");
  boxPublic.innerHTML="";
  boxPrivate.innerHTML="";

  snapshot.forEach(docSnap=>{
    const m=docSnap.data();
    const id=docSnap.id;

    let div=document.createElement("div");
    div.className="msg";

    // Ø±ÛŒÙ¾Ù„Ø§ÛŒ
    if(m.replyTo){
      const replied=snapshot.docs.find(d=>d.id===m.replyTo)?.data();
      div.innerHTML+=`<div class="reply-box">â†ª Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${replied?.name}: ${replied?.text}</div>`;
    }

    const timeStr = m.time?new Date(m.time.seconds*1000).toLocaleTimeString("fa-IR"):"";
    div.innerHTML+=`<div class="msg-header"><b>${m.name}</b> â° ${timeStr}</div>`;
    div.innerHTML+=`<div class="msg-text">${m.text}</div>`;

    // Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†
    div.innerHTML+=`<div class="reactions">
      <span onclick="react('${id}','â¤ï¸')">â¤ï¸ ${m.reactions?.heart?.length||0}</span>
      <span onclick="react('${id}','ğŸ‘')">ğŸ‘ ${m.reactions?.like?.length||0}</span>
    </div>`;

    // Ø­Ø°Ù Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ ÙÙ‚Ø· Ø®ÙˆØ¯ Ù¾ÛŒØ§Ù…
    if(m.userId===userId){
      const del=document.createElement("button"); del.textContent="âŒ Ø­Ø°Ù"; del.onclick=()=>messagesRef.doc(id).delete();
      const edit=document.createElement("button"); edit.textContent="âœï¸"; edit.onclick=()=>{
        const t=prompt("ÙˆÛŒØ±Ø§ÛŒØ´:", m.text); if(t) messagesRef.doc(id).update({text:t});
      };
      div.querySelector(".reactions").appendChild(del);
      div.querySelector(".reactions").appendChild(edit);
    }

    // Ø±ÛŒÙ¾Ù„Ø§ÛŒ
    const replyBtn=document.createElement("button"); replyBtn.textContent="â†©ï¸"; replyBtn.onclick=()=>setReply(id);
    div.querySelector(".reactions").appendChild(replyBtn);

    // ØªÙÚ©ÛŒÚ© Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ø®ØµÙˆØµÛŒØŒ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ù„Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
    if(m.receiverId){
      if(m.userId===userId || m.receiverId===userId) boxPrivate.prepend(div);
    } else {
      boxPublic.prepend(div);
    }
  });

  // Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
  if(!firstLoad && snapshot.docChanges().length){
    snapshot.docChanges().forEach(changeDoc=>{
      const change = changeDoc.doc.data();
      let showNotification = false;

      if(change.receiverId){
        showNotification = ((change.userId===userId || change.receiverId===userId));
      } else {
        showNotification = true;
      }

      if(showNotification && change.userId!==userId && Notification.permission==="granted")
        new Notification(`Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ${change.name}`,{body:change.text});
      if(showNotification && change.userId!==userId) document.getElementById("notifSound").play();
    });
  }
  firstLoad=false;

  // Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ
  usersRef.get().then(snap=>{
    const sel=document.getElementById("receiver");
    sel.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
    snap.forEach(u=>{if(u.id!==userId) sel.innerHTML+=`<option value="${u.id}">${u.data().name}</option>`;});
  });
});

// Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±
function react(id,type){
  messagesRef.doc(id).get().then(docSnap=>{
    const data=docSnap.data();
    const reactions=data.reactions || {heart:[],like:[]};
    const field=type==='â¤ï¸'?'heart':'like';
    if(!reactions[field]) reactions[field]=[];

    const idx=reactions[field].indexOf(userId);
    if(idx===-1) reactions[field].push(userId); else reactions[field].splice(idx,1);
    messagesRef.doc(id).update({reactions});
  });
}

// ØªØºÛŒÛŒØ± Ù†Ø§Ù…
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:"); 
  if(n){
    username=n; 
    localStorage.setItem("chatName",n); 
    document.getElementById("displayName").innerText=n; 
    usersRef.doc(userId).update({name:n});
  }
}
</script>
</body>
  </html>
