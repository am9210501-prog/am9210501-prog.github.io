<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>IRN Chat</title>
  <style>
    body { font-family: sans-serif; background:#0f172a; color:white; }
    #chat { height:300px; overflow-y:auto; border:1px solid #334155; padding:10px; margin-bottom:10px; }
    .msg { margin:5px 0; padding:6px; background:#1e293b; border-radius:6px; }
    .reply { font-size:12px; color:#94a3b8; }
    button { margin-left:5px; }
    #notif { background:#16a34a; padding:5px; display:none; margin-bottom:10px; }
  </style>
</head>
<body>

<h2>IRN Chat</h2>
<div id="notif"></div>
<div id="chat"></div>

<input id="name" placeholder="Ù†Ø§Ù…" />
<input id="text" placeholder="Ù¾ÛŒØ§Ù…..." />
<button onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  deleteDoc, doc, query, orderBy, updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQdlikB...",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat",
  storageBucket: "irn-chat.firebasestorage.app",
  messagingSenderId: "247317938517",
  appId: "1:247317938517:web:2343d222bebb00ebd8afdc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chat = document.getElementById("chat");
const notif = document.getElementById("notif");

let replyTo = null;
let unreadCount = 0;
let firstLoad = true;

const q = query(collection(db, "messages"), orderBy("time"));

onSnapshot(q, snapshot => {
  chat.innerHTML = "";
  
  snapshot.forEach(docSnap => {
    const msg = docSnap.data();
    const id = docSnap.id;

    const div = document.createElement("div");
    div.className = "msg";

    if(msg.replyText){
      div.innerHTML += `<div class="reply">â†ª ${msg.replyText}</div>`;
    }

    div.innerHTML += `<b>${msg.name}</b>: ${msg.text}`;

    const delBtn = document.createElement("button");
    delBtn.textContent = "Ø­Ø°Ù";
    delBtn.onclick = () => deleteDoc(doc(db, "messages", id));

    const repBtn = document.createElement("button");
    repBtn.textContent = "Ø±ÛŒÙ¾Ù„Ø§ÛŒ";
    repBtn.onclick = () => {
      replyTo = msg.text;
      document.getElementById("text").placeholder = "Ø¯Ø± Ø­Ø§Ù„ Ø±ÛŒÙ¾Ù„Ø§ÛŒ...";
    };

    div.appendChild(delBtn);
    div.appendChild(repBtn);

    chat.appendChild(div);
  });

  // Ø§Ø¹Ù„Ø§Ù† Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
  if(!firstLoad){
    unreadCount++;
    notif.style.display = "block";
    notif.textContent = `ðŸ”” ${unreadCount} Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±ÛŒØ¯`;
  }

  firstLoad = false;
  chat.scrollTop = chat.scrollHeight;
});

window.send = async function(){
  const name = document.getElementById("name").value;
  const text = document.getElementById("text").value;
  if(!name || !text) return;

  await addDoc(collection(db, "messages"), {
    name,
    text,
    replyText: replyTo || "",
    time: Date.now()
  });

  replyTo = null;
  document.getElementById("text").value = "";
  document.getElementById("text").placeholder = "Ù¾ÛŒØ§Ù…...";
}

// ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆØ¯
window.onload = () => {
  unreadCount = 0;
  notif.style.display = "none";
}
</script>

</body>
</html>
