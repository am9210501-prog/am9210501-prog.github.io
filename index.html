<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro - Ø¬Ø§Ù…Ø¹</title>
<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;}
.top-bar{background:#0d6efd;padding:10px;color:white;display:flex;justify-content:space-between;align-items:center;font-size:14px}
.top-bar button{background:white;color:#0d6efd;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;margin-left:5px}
.chat{max-width:700px;margin:auto;padding:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px;position:relative;animation:fade .3s}
.msg small{color:#aaa;font-size:12px}
.reactions span{margin-left:8px;cursor:pointer}
input,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
.reply-box{background:#333;padding:5px;margin-bottom:5px;border-radius:5px;font-size:12px;color:#fff3cd}
#typingStatus{font-size:12px;color:#aaa;margin-bottom:5px}
#onlineUsers{font-size:12px;color:#0f0;margin-bottom:5px}
#messagesPublic{max-height:300px;overflow-y:auto;padding:5px;border-radius:5px;margin-bottom:10px;background:#111;}
#searchResults div{padding:8px;border-bottom:1px solid #444;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
#searchResults div:hover{background:#0d6efd;}
.privateChatWindow{position:fixed;bottom:0;right:20px;width:300px;background:#111;border:1px solid #444;border-radius:6px;display:flex;flex-direction:column;z-index:100;}
.privateChatWindow .header{background:#0d6efd;padding:5px;color:white;cursor:move;display:flex;justify-content:space-between;}
.privateChatWindow .messages{flex:1;overflow-y:auto;padding:5px;}
.privateChatWindow input{border-radius:0;margin:0;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
.online-dot{height:10px;width:10px;background:#0f0;border-radius:50%;display:inline-block;margin-left:5px;}
</style>
</head>
<body>

<div class="top-bar">
  <span>ðŸ‘¤ <strong id="displayName"></strong></span>
  <div>
    <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
  </div>
</div>

<div class="chat">
  <div id="onlineUsers"></div>
  <div id="typingStatus"></div>
  <div id="replyBox"></div>

  <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
  <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
  <div id="messagesPublic"></div>

  <h3>Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ</h3>
  <input id="userSearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ">
  <div id="searchResults"></div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
// ====== Firebase Config ======
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

// ====== User Setup ======
let userId = localStorage.getItem("userId");
if(!userId){
  userId = Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}
let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³";
  localStorage.setItem("chatName", username);
}
document.getElementById("displayName").innerText = username;
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload", ()=>usersRef.doc(userId).update({online:false}));

// ====== Typing Status ======
document.getElementById("text").addEventListener("input", ()=>{
  typingRef.doc(userId).set({name:username});
  setTimeout(()=>typingRef.doc(userId).delete().catch(()=>{}),1500);
});
typingRef.onSnapshot(snap=>{
  let names=[];
  snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// ====== Online Users ======
usersRef.onSnapshot(snap=>{
  let html="";
  snap.forEach(u=>{
    const data = u.data();
    if(data.online) html+=data.name+" ";
  });
  document.getElementById("onlineUsers").innerText="Ø¢Ù†Ù„Ø§ÛŒÙ†: "+html;
});

// ====== Search & Private Chat ======
const searchInput = document.getElementById("userSearch");
const resultsBox = document.getElementById("searchResults");
let usersCache = [];
let privateChats = {}; // Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ

usersRef.onSnapshot(snap=>{
  usersCache = [];
  snap.forEach(u=>{
    if(u.id !== userId) usersCache.push({id:u.id, name:u.data().name, online:u.data().online});
  });
});

searchInput.addEventListener("input", ()=>{
  const q = searchInput.value.trim().toLowerCase();
  resultsBox.innerHTML="";
  if(!q) return;
  usersCache.filter(u=>u.name.toLowerCase().includes(q)).forEach(u=>{
    const div=document.createElement("div");
    div.innerHTML=`<span>${u.name}</span>${u.online?'<span class="online-dot"></span>':''}`;
    div.onclick=()=>openPrivateChat(u.id,u.name);
    resultsBox.appendChild(div);
  });
});

// ====== Open Private Chat Window ======
function openPrivateChat(otherId,otherName){
  if(privateChats[otherId]) return; // Ø§Ú¯Ø± Ø¨Ø§Ø² Ø§Ø³Øª
  const chatDiv = document.createElement("div");
  chatDiv.className="privateChatWindow";
  chatDiv.innerHTML=`
    <div class="header">${otherName} <span style="cursor:pointer" onclick="closePrivateChat('${otherId}')">âœ–</span></div>
    <div class="messages" id="chatMsgs_${otherId}"></div>
    <input placeholder="Ù¾ÛŒØ§Ù…..." id="chatInput_${otherId}">
    <button onclick="sendPrivateMessage('${otherId}')">Ø§Ø±Ø³Ø§Ù„</button>
  `;
  document.body.appendChild(chatDiv);
  privateChats[otherId]=chatDiv;

  // Ù„ÙˆØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ
  messagesRef.orderBy("time").onSnapshot(snapshot=>{
    const box = document.getElementById(`chatMsgs_${otherId}`);
    if(!box) return;
    box.innerHTML="";
    snapshot.forEach(docSnap=>{
      const m = docSnap.data();
      if(m.receiverId === otherId || m.userId === otherId){
        const div = document.createElement("div");
        div.className="msg";
        div.innerText = `${m.name}: ${m.text}${m.seen?" âœ…":""}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        // Seen
        if(m.receiverId === userId && !m.seen){
          messagesRef.doc(docSnap.id).update({seen:true});
        }
      }
    });
  });
}

function closePrivateChat(otherId){
  const chatDiv = privateChats[otherId];
  if(chatDiv) chatDiv.remove();
  delete privateChats[otherId];
}

// ====== Send Private Message ======
function sendPrivateMessage(otherId){
  const input = document.getElementById(`chatInput_${otherId}`);
  const text = input.value.trim();
  if(!text) return;
  messagesRef.add({
    name:username,
    text,
    userId,
    receiverId:otherId,
    reactions:{heart:[],like:[]},
    replyTo:null,
    time: firebase.firestore.FieldValue.serverTimestamp(),
    seen:false
  });
  input.value="";
}

// ====== Public Messages ======
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  const box=document.getElementById("messagesPublic");
  box.innerHTML="";
  snapshot.forEach(docSnap=>{
    const m = docSnap.data();
    const div=document.createElement("div");
    div.className="msg";
    if(!m.receiverId){
      div.innerHTML=`<b>${m.name}</b>: ${m.text}`;
      box.prepend(div);
    }
  });
});

// ====== Send Public Message ======
function sendMessage(){
  const text = document.getElementById("text").value.trim();
  if(!text) return alert("Ù¾ÛŒØ§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  messagesRef.add({
    name:username,
    text,
    userId,
    receiverId:null,
    reactions:{heart:[],like:[]},
    replyTo:null,
    time: firebase.firestore.FieldValue.serverTimestamp(),
    seen:false
  });
  document.getElementById("text").value="";
}

// ====== Change Name ======
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(n){
    username=n;
    localStorage.setItem("chatName",n);
    document.getElementById("displayName").innerText=n;
    usersRef.doc(userId).update({name:n});
  }
}
</script>

</body>
</html>
