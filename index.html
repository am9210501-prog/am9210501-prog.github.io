<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro - Ø¬Ù…Ø¹â€ŒÙˆØ¬ÙˆØ±</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

body, html {
    margin:0; padding:0;
    font-family:'Vazirmatn',tahoma;
    background:#0b1a2f;
    color:white;
    height:100vh;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    font-size:13px;
}

#loadingScreen {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:#0b1a2f; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999;
}
#loadingScreen h1{font-size:24px;}
#loadingScreen p{font-size:14px;color:#aaa;margin-top:5px;text-align:center;}

#publicView,#privateView{flex:1; display:flex; flex-direction:column; padding:6px; overflow:hidden;}
.messages{flex:1; overflow-y:auto; padding:2px; margin-bottom:2px; background:#111; border-radius:5px;}
.msg{background:#222; margin:2px; padding:3px; border-radius:5px; position:relative; display:flex; justify-content:space-between; align-items:center; font-size:12px;}
.msg button{margin-left:3px; background:#555; color:white; border:none; border-radius:3px; cursor:pointer; padding:2px 4px; font-size:11px;}
.ticks{margin-left:3px;font-size:11px;color:#0f0;}
.sent{color:#aaa;}
.seen{color:#0f0;}
.chat-input{display:flex;}
.chat-input input{flex:1;padding:5px;border-radius:4px;border:none;margin-right:3px;font-size:12px;}
.chat-input button{padding:5px 6px;border:none;border-radius:4px;background:#00aaff;color:white;cursor:pointer;font-size:12px;}
#privateBtn,#backBtn{padding:6px 8px;margin:2px 0;font-size:13px;border-radius:5px;background:#0d6efd;color:white;cursor:pointer;}
.sidebar{width:200px;background:#111;border-right:1px solid #444;display:flex;flex-direction:column;overflow-y:auto;}
.sidebar h3{margin:5px;padding:5px;border-bottom:1px solid #444;font-size:13px;}
.sidebar .userItem{padding:3px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:12px;}
.sidebar .userItem:hover{background:#0d6efd;}
.online-dot{width:8px;height:8px;border-radius:50%;background:#0f0;display:inline-block;margin-left:5px;}
.unread-count{background:red;color:white;border-radius:50%;padding:1px 4px;margin-left:4px;font-size:11px;}
.privateChatWindow{flex:1; display:flex; flex-direction:column;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<div id="loadingScreen">
  <h1>Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡</h1>
  <p>Â«Ø³Ø±Ø¹ØªØŒ Ø§Ù…Ù†ÛŒØªØŒ Ø§Ø±ØªØ¨Ø§Ø·Â»</p>
</div>

<div id="publicView" style="display:none;">
  <div>ğŸ‘¤ <strong id="displayName"></strong> <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button></div>
  <div id="typingStatus" style="font-size:12px;color:#aaa;"></div>
  <div class="messages" id="messagesPublic"></div>
  <div class="chat-input">
    <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
    <button onclick="sendPublicMessage()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
  <button id="privateBtn">ğŸ’¬ Ú†Øª Ø®ØµÙˆØµÛŒ <span id="unreadPrivateCount" class="unread-count" style="display:none">0</span></button>
</div>

<div id="privateView" style="display:none; flex:1; flex-direction:row;">
  <div class="sidebar">
    <h3>Ú†Øª Ø®ØµÙˆØµÛŒ</h3>
    <input id="privateSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†" style="margin:5px;padding:4px;border-radius:4px;border:none;font-size:12px;">
    <div id="privateUserList"></div>
    <button id="backBtn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ</button>
  </div>
  <div class="privateChatWindow">
    <div id="privateChatContainer" style="flex:1;display:flex;flex-direction:column;">
      <div class="messages" id="privateMessages"></div>
      <div class="chat-input">
        <input id="privateText" placeholder="Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ...">
        <button onclick="sendPrivateMessage()">Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
// Firebase
const firebaseConfig = { apiKey:"YOUR_KEY", authDomain:"irn-chat.firebaseapp.com", projectId:"irn-chat" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

// User setup
let userId = localStorage.getItem("userId");
if(!userId){ userId=Math.random().toString(36).substr(2,9); localStorage.setItem("userId",userId);}
let username = localStorage.getItem("chatName");
if(!username){ username=prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³"; localStorage.setItem("chatName",username);}
document.getElementById("displayName").innerText=username;
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload",()=>usersRef.doc(userId).update({online:false}));

window.addEventListener("load", ()=>{
  setTimeout(()=>{document.getElementById("loadingScreen").style.display="none"; document.getElementById("publicView").style.display="flex";},1200);
});

// Typing
document.getElementById("text").addEventListener("input", ()=>{
  typingRef.doc(userId).set({name:username});
  setTimeout(()=>typingRef.doc(userId).delete().catch(()=>{}),1500);
});
typingRef.onSnapshot(snap=>{
  let names=[];
  snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// Views toggle
const publicView=document.getElementById("publicView");
const privateView=document.getElementById("privateView");
const unreadCounter = document.getElementById("unreadPrivateCount");
document.getElementById("privateBtn").onclick=()=>{ publicView.style.display="none"; privateView.style.display="flex"; markPrivateMessagesAsRead(); };
document.getElementById("backBtn").onclick=()=>{ publicView.style.display="flex"; privateView.style.display="none"; };

// Online users & unread
let usersCache=[];
usersRef.onSnapshot(snap=>{
  usersCache=[];
  const listDiv=document.getElementById("privateUserList"); listDiv.innerHTML="";
  snap.forEach(u=>{ if(u.id!==userId){ const data=u.data(); usersCache.push({id:u.id,name:data.name,online:data.online}); } });
  renderPrivateUsers(usersCache);
});
function renderPrivateUsers(users){
  const listDiv=document.getElementById("privateUserList"); listDiv.innerHTML="";
  users.forEach(u=>{
    const div=document.createElement("div"); div.className="userItem"; div.id="userItem-"+u.id;
    div.innerHTML=`<span>${u.name}</span><span id="userUnread-${u.id}" class="unread-count" style="display:none">0</span>${u.online?'<span class="online-dot"></span>':''}`;
    div.onclick=()=>selectPrivateUser(u.id,u.name);
    listDiv.appendChild(div);
  });
}
function updateUnreadPerUser(){
  messagesRef.where("receiverId","==",userId).where("seen","==",false).onSnapshot(snap=>{
    let countMap={};
    snap.forEach(doc=>{ const m=doc.data(); if(m.userId){ countMap[m.userId]=(countMap[m.userId]||0)+1; } });
    usersCache.forEach(u=>{
      const el=document.getElementById("userUnread-"+u.id);
      if(el){ if(countMap[u.id]>0){ el.style.display="inline-block"; el.innerText=countMap[u.id]; } else { el.style.display="none"; } }
    });
    const totalUnread=Object.values(countMap).reduce((a,b)=>a+b,0);
    if(totalUnread>0){ unreadCounter.style.display="inline-block"; unreadCounter.innerText=totalUnread; } else unreadCounter.style.display="none";
  });
}

// Private chat
let selectedPrivateUser=null;
function selectPrivateUser(id,name){ selectedPrivateUser={id,name}; loadPrivateMessages(); markMessagesAsReadFrom(id); }
function loadPrivateMessages(){
  const box=document.getElementById("privateMessages"); if(!selectedPrivateUser) return;
  messagesRef.orderBy("time").onSnapshot(snapshot=>{
    box.innerHTML="";
    snapshot.forEach(docSnap=>{
      const m=docSnap.data();
      const isPrivate=(m.userId===userId && m.receiverId===selectedPrivateUser.id)||(m.userId===selectedPrivateUser.id && m.receiverId===userId);
      if(isPrivate){
        const msgDiv=document.createElement("div"); msgDiv.className="msg";
        let tick=""; if(m.userId===userId){ tick=m.seen?"<span class='ticks seen'>âœ”ï¸</span>":"<span class='ticks sent'>âœ…</span>"; }
        let buttons="";
        if(m.userId===userId){ buttons=`<button onclick="deleteMsg('${docSnap.id}')">âŒ</button>`; }
        buttons+=`<button onclick="replyMsg('${m.text}', ${m.userId===userId})">â†©ï¸</button>`;
        msgDiv.innerHTML=`<span>${m.name}: ${m.text}</span>${tick}${buttons}`;
        box.appendChild(msgDiv); box.scrollTop=box.scrollHeight;
      }
    });
  });
}
function deleteMsg(msgId){ messagesRef.doc(msgId).delete(); }
function replyMsg(text,isMine){ 
  const input = isMine ? document.getElementById("text") : document.getElementById("privateText");
  input.value = `â†ª ${text} `;
}
function markMessagesAsReadFrom(senderId){ messagesRef.where("receiverId","==",userId).where("userId","==",senderId).where("seen","==",false).get().then(snapshot=>{ snapshot.forEach(doc=>{ messagesRef.doc(doc.id).update({seen:true}); }); }); }
function markPrivateMessagesAsRead(){ messagesRef.where("receiverId","==",userId).where("seen","==",false).get().then(snapshot=>{ snapshot.forEach(doc=>{ messagesRef.doc(doc.id).update({seen:true}); }); }); }

// Send
function sendPrivateMessage(){
  if(!selectedPrivateUser) return alert("Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  const input=document.getElementById("privateText"); const text=input.value.trim(); if(!text) return;
  messagesRef.add({ name:username,text,userId,receiverId:selectedPrivateUser.id,reactions:{heart:[],like:[]},replyTo:null,time:firebase.firestore.FieldValue.serverTimestamp(),seen:false });
  input.value="";
}
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  const box=document.getElementById("messagesPublic"); box.innerHTML="";
  snapshot.forEach(docSnap=>{
    const m=docSnap.data(); if(!m.receiverId){
      const div=document.createElement("div"); div.className="msg";
      let tick=""; if(m.userId===userId){ tick=m.seen?"<span class='ticks seen'>âœ”ï¸</span>":"<span class='ticks sent'>âœ…</span>"; }
      let buttons="";
      if(m.userId===userId){ buttons=`<button onclick="deleteMsg('${docSnap.id}')">âŒ</button>`; }
      buttons+=`<button onclick="replyMsg('${m.text}', true)">â†©ï¸</button>`;
      div.innerHTML=`<span>${m.name}: ${m.text}</span>${tick}${buttons}`;
      box.prepend(div);
    }
  });
});
function sendPublicMessage(){
  const text=document.getElementById("text").value.trim(); if(!text) return alert("Ù¾ÛŒØ§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  messagesRef.add({ name:username,text,userId,receiverId:null,reactions:{heart:[],like:[]},replyTo:null,time:firebase.firestore.FieldValue.serverTimestamp(),seen:false });
  document.getElementById("text").value="";
}
function changeName(){ const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:"); if(n){ username=n; localStorage.setItem("chatName",n); document.getElementById("displayName").innerText=n; usersRef.doc(userId).update({name:n}); } }
if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();
updateUnreadPerUser();
</script>
</body>
</html>
