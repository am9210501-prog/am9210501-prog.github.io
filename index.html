<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Messenger Pro</title>

<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0}
.top-bar{background:#0d6efd;padding:10px;display:flex;justify-content:space-between;align-items:center}
.chat{max-width:700px;margin:auto;padding:15px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px;animation:fade .3s}
.msg small{color:#aaa}
.reactions span{margin-left:8px;cursor:pointer}
input,select,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
.dark{background:#050816}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<div class="top-bar">
  <span>ğŸ‘¤ <strong id="displayName"></strong></span>
  <div>
    <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
    <button onclick="toggleDark()">ğŸŒ™</button>
  </div>
</div>

<div class="chat">

<div id="onlineUsers">ğŸ‘¥ Ø¢Ù†Ù„Ø§ÛŒÙ†: 0</div>
<div id="typingStatus" style="font-size:14px;color:#aaa"></div>

<select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
<input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

<div id="messages"></div>

</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

// ===== Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± =====
let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("Ù†Ø§Ù… ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
  localStorage.setItem("chatName", username || "Ú©Ø§Ø±Ø¨Ø±");
}
document.getElementById("displayName").innerText = username;

function changeName(){
  const n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(n){
    username = n;
    localStorage.setItem("chatName", n);
    document.getElementById("displayName").innerText = n;
  }
}

// ===== Ø¢Ù†Ù„Ø§ÛŒÙ† =====
const userId = localStorage.getItem("uid") || Date.now().toString();
localStorage.setItem("uid", userId);
usersRef.doc(userId).set({name:username,online:true});

window.addEventListener("beforeunload",()=>{
  usersRef.doc(userId).update({online:false});
});

usersRef.onSnapshot(s=>{
  let count=0;
  s.forEach(d=>{if(d.data().online) count++;});
  document.getElementById("onlineUsers").innerText="ğŸ‘¥ Ø¢Ù†Ù„Ø§ÛŒÙ†: "+count;
});

// ===== ØªØ§ÛŒÙ¾ =====
document.getElementById("text").addEventListener("input",()=>{
  typingRef.doc(userId).set({name:username});
  setTimeout(()=>typingRef.doc(userId).delete(),1500);
});

typingRef.onSnapshot(s=>{
  let arr=[];
  s.forEach(d=>{ if(d.id!==userId) arr.push(d.data().name);});
  document.getElementById("typingStatus").innerText =
    arr.length ? arr.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾..." : "";
});

// ===== Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… =====
function sendMessage(){
  const text = document.getElementById("text").value.trim();
  const receiverId = document.getElementById("receiver").value || null;
  if(!text) return;

  messagesRef.add({
    name:username,
    text,
    userId,
    receiverId,
    reactions:{},
    seenBy:[userId],
    replyTo:null,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("text").value="";
}

// ===== Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… =====
let firstLoad=true;
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  const box=document.getElementById("messages");
  box.innerHTML="";

  snapshot.forEach(doc=>{
    const m=doc.data();
    if(m.receiverId && m.receiverId!==userId && m.userId!==userId) return;

    // Ø«Ø¨Øª Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù†
    if(!m.seenBy.includes(userId)){
      messagesRef.doc(doc.id).update({
        seenBy: firebase.firestore.FieldValue.arrayUnion(userId)
      });
    }

    let div=document.createElement("div");
    div.className="msg";

    const time=m.time? new Date(m.time.seconds*1000).toLocaleTimeString("fa-IR"):"";
    const seen=m.seenBy.length>1?"âœ“âœ“":"âœ“";

    div.innerHTML=`
      <b>${m.name}</b> <small>${time}</small> ${seen}<br>
      ${m.replyTo?`<small>â†ª Ù¾Ø§Ø³Ø®</small><br>`:""}
      ${m.text}
      <div class="reactions">
        â¤ï¸ ${m.reactions.heart||0}
        ğŸ‘ ${m.reactions.like||0}
        ğŸ˜‚ ${m.reactions.laugh||0}
      </div>
    `;

    // Ø­Ø°Ù
    if(m.userId===userId){
      const del=document.createElement("button");
      del.textContent="âŒ";
      del.onclick=()=>messagesRef.doc(doc.id).delete();
      div.appendChild(del);

      const edit=document.createElement("button");
      edit.textContent="âœï¸";
      edit.onclick=()=>{
        const t=prompt("ÙˆÛŒØ±Ø§ÛŒØ´:",m.text);
        if(t) messagesRef.doc(doc.id).update({text:t});
      };
      div.appendChild(edit);
    }

    // Ø±ÛŒÙ¾Ù„Ø§ÛŒ
    const reply=document.createElement("button");
    reply.textContent="â†©ï¸";
    reply.onclick=()=>{
      document.getElementById("text").value="â†ª "+m.text;
    };
    div.appendChild(reply);

    // Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†
    div.onclick=()=>{
      messagesRef.doc(doc.id).update({
        "reactions.heart": (m.reactions.heart||0)+1
      });
    };

    box.appendChild(div);
  });

  // ğŸ”” ØµØ¯Ø§ + Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
  if(!firstLoad && snapshot.docChanges().length){
    document.getElementById("notifSound").play();
    const msg=snapshot.docChanges()[0].doc.data();
    if(Notification.permission==="granted" && msg.userId!==userId){
      new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² "+msg.name,{body:msg.text});
    }
  }
  firstLoad=false;

  // Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
  usersRef.get().then(s=>{
    const sel=document.getElementById("receiver");
    sel.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
    s.forEach(u=>{
      if(u.id!==userId)
        sel.innerHTML+=`<option value="${u.id}">${u.data().name}</option>`;
    });
  });
});

// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
if("Notification" in window && Notification.permission!=="granted"){
  Notification.requestPermission();
}

// Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯
function toggleDark(){
  document.body.classList.toggle("dark");
}
</script>
</body>
  </html>
