<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro + Games</title>

<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;display:flex;flex-direction:column;height:100vh;}
.messages{flex:1;overflow-y:auto;padding:5px;border-radius:6px;background:#111;margin-bottom:5px;}
.msg{background:#222;margin:5px;padding:5px;border-radius:6px;}
.chat-input{display:flex;}
.chat-input input{flex:1;padding:10px;border-radius:6px;border:none;margin-right:5px;}
.chat-input button{padding:10px;border:none;border-radius:6px;background:#00aaff;color:white;}
button{cursor:pointer}
.sidebar{width:250px;background:#111;border-right:1px solid #444;}
.userItem{padding:5px;cursor:pointer;display:flex;justify-content:space-between;}
.online-dot{width:10px;height:10px;border-radius:50%;background:#0f0;display:inline-block;}
</style>
</head>
<body>

<!-- ===== PUBLIC VIEW ===== -->
<div id="publicView">
  ğŸ‘¤ <span id="displayName"></span>
  <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>

  <div class="messages" id="messagesPublic"></div>

  <div class="chat-input">
    <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
    <button onclick="sendPublicMessage()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>

  <button id="privateBtn">ğŸ’¬ Ú†Øª Ø®ØµÙˆØµÛŒ</button>
  <button id="gamesBtn">ğŸ® Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</button>
</div>

<!-- ===== PRIVATE VIEW ===== -->
<div id="privateView" style="display:none;height:100%;">
  <div class="sidebar">
    <h3>Ú†Øª Ø®ØµÙˆØµÛŒ</h3>
    <div id="privateUserList"></div>
    <button id="backBtn">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </div>

  <div style="flex:1;display:flex;flex-direction:column;">
    <div class="messages" id="privateMessages"></div>
    <div class="chat-input">
      <input id="privateText" placeholder="Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ...">
      <button onclick="sendPrivateMessage()">Ø§Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<!-- ===== GAMES VIEW ===== -->
<div id="gamesView" style="display:none;padding:10px;">
  <button id="backFromGames">â¬… Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  <h2>ğŸ® Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</h2>

  <button onclick="openGame('tic')">Ø¯ÙˆØ²</button>
  <button onclick="openGame('snake')">Ù…Ø§Ø±</button>
  <button onclick="openGame('ladder')">Ù…Ø§Ø± Ùˆ Ù¾Ù„Ù‡</button>

  <div id="gameContainer" style="margin-top:15px;"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase =====
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");

// ===== User =====
let userId = localStorage.getItem("userId");
if(!userId){ userId=Math.random().toString(36).substr(2,9); localStorage.setItem("userId",userId);}
let username = localStorage.getItem("chatName") || prompt("Ù†Ø§Ù… Ø´Ù…Ø§ØŸ") || "Ú©Ø§Ø±Ø¨Ø±";
document.getElementById("displayName").innerText=username;
usersRef.doc(userId).set({name:username,online:true});
window.addEventListener("beforeunload",()=>usersRef.doc(userId).update({online:false}));

// ===== Views =====
const publicView=document.getElementById("publicView");
const privateView=document.getElementById("privateView");
const gamesView=document.getElementById("gamesView");

document.getElementById("privateBtn").onclick=()=>{
  publicView.style.display="none";
  privateView.style.display="flex";
};

document.getElementById("backBtn").onclick=()=>{
  privateView.style.display="none";
  publicView.style.display="block";
};

document.getElementById("gamesBtn").onclick=()=>{
  publicView.style.display="none";
  gamesView.style.display="block";
};

document.getElementById("backFromGames").onclick=()=>{
  gamesView.style.display="none";
  publicView.style.display="block";
};

// ===== Public Chat =====
messagesRef.orderBy("time").onSnapshot(snap=>{
  const box=document.getElementById("messagesPublic");
  box.innerHTML="";
  snap.forEach(doc=>{
    const m=doc.data();
    if(!m.receiverId){
      const div=document.createElement("div");
      div.className="msg";
      div.textContent=`${m.name}: ${m.text}`;
      box.prepend(div);
    }
  });
});

function sendPublicMessage(){
  const text=document.getElementById("text").value.trim();
  if(!text) return;
  messagesRef.add({name:username,text,userId,time:Date.now()});
  document.getElementById("text").value="";
}

// ===== Private Chat =====
let selectedUser=null;

usersRef.onSnapshot(snap=>{
  const list=document.getElementById("privateUserList");
  list.innerHTML="";
  snap.forEach(doc=>{
    if(doc.id!==userId){
      const u=doc.data();
      const div=document.createElement("div");
      div.className="userItem";
      div.innerHTML=`${u.name} ${u.online?'<span class="online-dot"></span>':''}`;
      div.onclick=()=>{selectedUser=doc.id;loadPrivateMessages();};
      list.appendChild(div);
    }
  });
});

function loadPrivateMessages(){
  const box=document.getElementById("privateMessages");
  messagesRef.orderBy("time").onSnapshot(snap=>{
    box.innerHTML="";
    snap.forEach(doc=>{
      const m=doc.data();
      if(m.receiverId && ((m.userId===userId && m.receiverId===selectedUser) || (m.userId===selectedUser && m.receiverId===userId))){
        const div=document.createElement("div");
        div.className="msg";
        div.textContent=`${m.name}: ${m.text}`;
        box.appendChild(div);
      }
    });
  });
}

function sendPrivateMessage(){
  const text=document.getElementById("privateText").value.trim();
  if(!text || !selectedUser) return;
  messagesRef.add({name:username,text,userId,receiverId:selectedUser,time:Date.now()});
  document.getElementById("privateText").value="";
}

// ===== Change Name =====
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(n){
    username=n;
    localStorage.setItem("chatName",n);
    document.getElementById("displayName").innerText=n;
    usersRef.doc(userId).update({name:n});
  }
}

//////////////////////////////
// ğŸ® GAMES SECTION
//////////////////////////////

function openGame(game){
  const container=document.getElementById("gameContainer");
  container.innerHTML="";
  if(game==="tic") loadTicTacToe(container);
  if(game==="snake") container.innerHTML="<p>Ø¨Ø§Ø²ÛŒ Ù…Ø§Ø± Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ğŸ</p>";
  if(game==="ladder") container.innerHTML="<p>Ù…Ø§Ø± Ùˆ Ù¾Ù„Ù‡ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ğŸ²</p>";
}

// ===== TIC TAC TOE =====
function loadTicTacToe(container){
  container.innerHTML=`
    <h3>Ø¯ÙˆØ²</h3>
    <div id="board" style="display:grid;grid-template-columns:repeat(3,80px);gap:5px;"></div>
    <p id="status"></p>
    <button onclick="resetGame()">Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
  `;
  const board=document.getElementById("board");
  let cells=Array(9).fill("");
  let current="X";

  function render(){
    board.innerHTML="";
    cells.forEach((val,i)=>{
      const cell=document.createElement("div");
      cell.style.cssText="width:80px;height:80px;background:#222;display:flex;align-items:center;justify-content:center;font-size:30px;cursor:pointer;";
      cell.textContent=val;
      cell.onclick=()=>move(i);
      board.appendChild(cell);
    });
  }

  function move(i){
    if(cells[i]) return;
    cells[i]=current;
    current=current==="X"?"O":"X";
    render();
    checkWin();
  }

  function checkWin(){
    const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for(const w of wins){
      if(cells[w[0]] && cells[w[0]]===cells[w[1]] && cells[w[1]]===cells[w[2]]){
        document.getElementById("status").innerText="Ø¨Ø±Ù†Ø¯Ù‡: "+cells[w[0]];
        board.style.pointerEvents="none";
      }
    }
  }

  window.resetGame=()=>{
    cells=Array(9).fill("");
    current="X";
    board.style.pointerEvents="auto";
    document.getElementById("status").innerText="";
    render();
  };

  render();
}
</script>
</body>
</html>
