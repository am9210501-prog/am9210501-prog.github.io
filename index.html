<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Messenger Pro</title>
<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;}
.top-bar{background:#0d6efd;padding:10px;display:flex;justify-content:space-between;align-items:center;color:white;font-size:14px}
.top-bar button{background:white;color:#0d6efd;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;margin-left:5px}
.chat{max-width:700px;margin:auto;padding:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px;position:relative;animation:fade .3s}
.msg small{color:#aaa;font-size:12px}
.msg .actions{margin-top:5px}
.msg .actions button{background:#00aaff;color:white;padding:3px 6px;margin-left:3px;border-radius:4px;cursor:pointer;font-size:12px;border:none}
.reply-box{background:#333;padding:5px;margin-bottom:5px;border-radius:5px;font-size:12px;color:#fff3cd}
.reactions span{margin-left:8px;cursor:pointer}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
#typingStatus{font-size:12px;color:#aaa;margin-bottom:5px}
</style>
</head>
<body>

<div class="top-bar">
  <span>ğŸ‘¤ <strong id="displayName"></strong></span>
  <div>
    <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
    <button onclick="toggleDark()">ğŸŒ™</button>
  </div>
</div>

<div class="chat">
<div id="typingStatus"></div>
<select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
<input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
<div id="messages"></div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const messagesRef = collection(db, "messages");
const usersRef = collection(db, "users");
const typingRef = collection(db, "typing");

let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("Ù†Ø§Ù… ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³";
  localStorage.setItem("chatName", username);
}
document.getElementById("displayName").innerText = username;

const userId = localStorage.getItem("uid") || Date.now().toString();
localStorage.setItem("uid", userId);

// Ø«Ø¨Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±
await updateDoc(doc(usersRef, userId)).catch(async()=>{
  await addDoc(usersRef, {name:username, online:true});
});

// ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯
document.getElementById("text").addEventListener("input", ()=>{
  updateDoc(doc(typingRef, userId)).catch(async()=>{
    await addDoc(typingRef, {name:username});
  });
  setTimeout(()=>deleteDoc(doc(typingRef, userId)),1500);
});

// Ø¯Ø±ÛŒØ§ÙØª ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯ Ø¯ÛŒÚ¯Ø±Ø§Ù†
onSnapshot(typingRef, snap=>{
  let names=[];
  snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
window.sendMessage = async function(){
  const text = document.getElementById("text").value.trim();
  const receiverId = document.getElementById("receiver").value || null;
  if(!text) return;

  await addDoc(messagesRef,{
    name: username,
    text,
    userId,
    receiverId,
    reactions:{},
    replyTo:null,
    time: serverTimestamp()
  });

  document.getElementById("text").value="";
};

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
let firstLoad=true;
onSnapshot(query(messagesRef, orderBy("time")), snapshot=>{
  const box = document.getElementById("messages");
  box.innerHTML="";

  snapshot.forEach(docItem=>{
    const m = docItem.data();
    const id = docItem.id;

    // ÙÙ‚Ø· Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ ÛŒØ§ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
    if(m.receiverId && m.receiverId!==userId && m.userId!==userId) return;

    let div = document.createElement("div");
    div.className="msg";

    // Ø±ÛŒÙ¾Ù„Ø§ÛŒ
    if(m.replyTo){
      div.innerHTML += `<div class="reply-box">â†ª Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„ÛŒ</div>`;
    }

    div.innerHTML += `<b>${m.name}:</b> ${m.text}<br>`;

    // Ù†Ù…Ø§ÛŒØ´ Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†
    if(m.reactions){
      Object.keys(m.reactions).forEach(e=>{
        div.innerHTML += `<span class="reactions" onclick="addReaction('${id}','${e}')">${e} ${m.reactions[e].length}</span>`;
      });
    }

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨ Ù¾ÛŒØ§Ù…
    if(m.userId===userId){
      const del = document.createElement("button");
      del.textContent="âŒ";
      del.onclick=()=>deleteDoc(doc(messagesRef,id));
      div.appendChild(del);

      const edit = document.createElement("button");
      edit.textContent="âœï¸";
      edit.onclick=()=>{
        const t=prompt("ÙˆÛŒØ±Ø§ÛŒØ´:", m.text);
        if(t) updateDoc(doc(messagesRef,id),{text:t});
      };
      div.appendChild(edit);
    }

    // Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡
    const reply = document.createElement("button");
    reply.textContent="â†©ï¸";
    reply.onclick=()=>alert("Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¯Ø± Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯");
    div.appendChild(reply);

    box.appendChild(div);
  });

  // ØµØ¯Ø§ + Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
  if(!firstLoad && snapshot.docChanges().length){
    document.getElementById("notifSound").play();
    const msg = snapshot.docChanges()[0].doc.data();
    if(Notification.permission==="granted" && msg.userId!==userId){
      new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² "+msg.name,{body:msg.text});
    }
  }
  firstLoad=false;
});

// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
if("Notification" in window && Notification.permission!=="granted"){
  Notification.requestPermission();
}

// Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯
function toggleDark(){document.body.classList.toggle("dark");}

// Ø§ÙØ²ÙˆØ¯Ù† Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†
window.addReaction = async function(messageId, emoji){
  const mRef = doc(messagesRef, messageId);
  const mSnap = await mRef.get();
  const mData = mSnap.data();
  const reactions = mData.reactions || {};
  if(!reactions[emoji]) reactions[emoji]=[];
  if(!reactions[emoji].includes(userId)) reactions[emoji].push(userId);
  updateDoc(mRef, {reactions});
};
</script>
</body>
</html>
