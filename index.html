<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro</title>

<style>
body{
  font-family:tahoma;
  background:#0b1a2f;
  color:white;
  margin:0;
  transition:0.3s;
}
.light body{background:#f4f4f4;color:#000;}

.top-bar{
  background:#0d6efd;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.chat{max-width:700px;margin:auto;padding:10px}

.msg{
  background:#222;
  margin:8px;
  padding:10px;
  border-radius:10px;
}

input,select,button{
  padding:10px;
  margin:5px;
  border:none;
  border-radius:6px;
}

button{background:#00aaff;color:white;cursor:pointer}

#messagesPublic,#messagesPrivate{
  max-height:250px;
  overflow-y:auto;
  background:#111;
  padding:5px;
  border-radius:5px;
}

.light #messagesPublic{background:#ddd;}
.light #messagesPrivate{background:#ccc;}

.search{width:95%}
.emoji{cursor:pointer;font-size:18px;margin:2px}
</style>
</head>

<body>

<div class="top-bar">
  <span>ğŸ‘¤ <strong id="displayName"></strong></span>
  <div>
    <button onclick="toggleTheme()">ğŸŒ™</button>
    <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
  </div>
</div>

<div class="chat">

  ğŸ” <input id="search" class="search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ§Ù…..." oninput="filterMessages()">

  <div id="onlineUsers"></div>

  <input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
  <div>
    ğŸ˜Š
    <span class="emoji" onclick="addEmoji('ğŸ˜€')">ğŸ˜€</span>
    <span class="emoji" onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span>
    <span class="emoji" onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
    <span class="emoji" onclick="addEmoji('ğŸ”¥')">ğŸ”¥</span>
  </div>

  <select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
  <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
  <div id="messagesPublic"></div>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ</h3>
  <div id="messagesPrivate"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");

let userId = localStorage.getItem("userId");
if(!userId){
  userId = Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

let username = localStorage.getItem("chatName");
if(!username){
  username = prompt("Ù†Ø§Ù… Ø´Ù…Ø§ØŸ") || "Ú©Ø§Ø±Ø¨Ø±";
  localStorage.setItem("chatName", username);
}
displayName.innerText = username;

// Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø±
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload", ()=>usersRef.doc(userId).update({online:false}));

// Ø¢Ù†Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§
setInterval(()=>{
  usersRef.where("online","==",true).get().then(snap=>{
    let names=[];
    snap.forEach(d=>names.push(d.data().name));
    onlineUsers.innerText="Ø¢Ù†Ù„Ø§ÛŒÙ†: "+names.join(" ØŒ ");
  });
},2000);

// Ø§ÛŒÙ…ÙˆØ¬ÛŒ
function addEmoji(e){ text.value += e; }

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(){
  const t=text.value.trim();
  const receiver=receiver.value||null;

  if(!t) return alert("Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
  if(t.length>500) return alert("Ù¾ÛŒØ§Ù… Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª");

  messagesRef.add({
    name:username,
    text:t,
    userId,
    receiverId:receiver,
    seenBy:[userId],
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  text.value="";
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
let allMessages=[];
messagesRef.orderBy("time").onSnapshot(snap=>{
  messagesPublic.innerHTML="";
  messagesPrivate.innerHTML="";
  allMessages=[];

  snap.forEach(doc=>{
    const m=doc.data();
    const id=doc.id;
    allMessages.push({id,...m});

    // seen
    if(m.receiverId===userId && !m.seenBy.includes(userId)){
      messagesRef.doc(id).update({seenBy:[...m.seenBy,userId]});
    }

    let div=document.createElement("div");
    div.className="msg";

    let seen = m.receiverId && m.seenBy.length>1 ? "âœ”âœ”" : "âœ”";

    div.innerHTML=`<b>${m.name}</b>: ${m.text} <small>${seen}</small>`;

    if(m.receiverId){
      if(m.receiverId===userId || m.userId===userId)
        messagesPrivate.prepend(div);
    } else {
      messagesPublic.prepend(div);
    }
  });

  // Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
  usersRef.get().then(s=>{
    receiver.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
    s.forEach(u=>{
      if(u.id!==userId)
        receiver.innerHTML+=`<option value="${u.id}">${u.data().name}</option>`;
    });
  });
});

// Ø¬Ø³ØªØ¬Ùˆ
function filterMessages(){
  const q=search.value.toLowerCase();
  document.querySelectorAll(".msg").forEach(m=>{
    m.style.display=m.innerText.toLowerCase().includes(q)?"block":"none";
  });
}

// ØªÙ…
function toggleTheme(){
  document.body.classList.toggle("light");
}

// ØªØºÛŒÛŒØ± Ù†Ø§Ù…
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(n){
    username=n;
    localStorage.setItem("chatName",n);
    displayName.innerText=n;
    usersRef.doc(userId).update({name:n});
  }
}
</script>
</body>
</html>
