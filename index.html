<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ IRN</title>
<style>
body{font-family:tahoma;text-align:center;background:#0b1a2f;color:white;transition:.3s}
.chat{max-width:600px;margin:auto;background:#111;padding:15px;border-radius:10px}
.msg{background:#222;margin:5px;padding:8px;border-radius:6px;text-align:right;position:relative}
.msg button{position:absolute;left:5px;top:5px;background:red;color:white;border:none;border-radius:4px;cursor:pointer;padding:2px 5px;}
.msg .react-btn{left:auto;right:5px;top:auto;bottom:5px;background:#00ff88;color:black;padding:2px 5px;}
input,select,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
.dark{background:#050816;color:white}
.dark .chat{background:#111}
#onlineUsers{margin:10px;font-size:14px}
</style>
</head>
<body>

<h2>ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ IRN</h2>
<div id="onlineUsers">ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†: 0</div>

<div>
<input id="name" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
<select id="receiver">
  <option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>
</select>
<input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø´Ù…Ø§">
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
<button onclick="toggleDark()">ğŸŒ™ Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯</button>
</div>

<div class="chat" id="messages"></div>
<audio id="notifySound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat",
  storageBucket: "irn-chat.firebasestorage.app",
  messagingSenderId: "247317938517",
  appId: "1:247317938517:web:2343d222bebb00ebd8afdc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");

let userId = localStorage.getItem("userId");
if(!userId){
  userId = Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

// Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø± Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†
function saveUser(status="online"){
  const name = document.getElementById("name").value.trim();
  if(!name) return;
  usersRef.doc(userId).set({name,status},{merge:true});
}
document.getElementById("name").addEventListener("change",()=>saveUser("online"));
saveUser("online");

// ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯ØŒ ÙˆØ¶Ø¹ÛŒØª Ø¢ÙÙ„Ø§ÛŒÙ† Ø´ÙˆØ¯
window.addEventListener("beforeunload",()=>saveUser("offline"));

// Ø´Ù…Ø§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
usersRef.onSnapshot(snap=>{
  let online = 0;
  snap.forEach(u=>{if(u.data().status==="online") online++;});
  document.getElementById("onlineUsers").innerText = `ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†: ${online}`;
});

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(){
  const name = document.getElementById("name").value.trim();
  const text = document.getElementById("text").value.trim();
  const receiverId = document.getElementById("receiver").value || null;
  if(!name || !text){ alert("Ù†Ø§Ù… Ùˆ Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†"); return; }

  messagesRef.add({
    name, text, userId, receiverId, reactions:{},
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("text").value="";
}

// Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯
function toggleDark(){
  document.body.classList.toggle("dark");
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
messagesRef.orderBy("time").onSnapshot(snapshot =>{
  const box = document.getElementById("messages");
  box.innerHTML = "";
  snapshot.forEach(docSnap=>{
    const m = docSnap.data();
    if(m.receiverId && m.receiverId!==userId && m.userId!==userId) return;
    let div = document.createElement("div");
    div.className="msg";
    const timeStr = m.time ? new Date(m.time.seconds*1000).toLocaleTimeString("fa-IR") : "";
    div.innerHTML=`<b>${m.name}</b> [${timeStr}]: ${m.text}`;

    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯
    if(m.userId === userId){
      let delBtn = document.createElement("button");
      delBtn.innerText="âŒ";
      delBtn.onclick = ()=>{ messagesRef.doc(docSnap.id).delete(); };
      div.appendChild(delBtn);

      // ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯
      let editBtn = document.createElement("button");
      editBtn.style.left="40px";
      editBtn.innerText="âœï¸";
      editBtn.onclick = ()=>{
        let newText = prompt("Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†:", m.text);
        if(newText) messagesRef.doc(docSnap.id).update({text:newText});
      };
      div.appendChild(editBtn);
    }

    // Ø±ÛŒâ€ŒØ§Ú©Ø´Ù†
    let reactBtn = document.createElement("button");
    reactBtn.className="react-btn";
    const userReact = m.reactions && m.reactions[userId] ? 1 : 0;
    reactBtn.innerText="â¤ï¸ " + Object.values(m.reactions||{}).reduce((a,b)=>a+b,0);
    reactBtn.onclick = ()=>{
      let newReactions = m.reactions || {};
      newReactions[userId] = newReactions[userId]?0:1;
      messagesRef.doc(docSnap.id).update({reactions:newReactions});
    };
    div.appendChild(reactBtn);

    box.appendChild(div);
  });

  // ØµØ¯Ø§ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
  if(snapshot.docChanges().length>0){
    document.getElementById("notifySound").play();
  }

  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´ Ø®ØµÙˆØµÛŒ
  usersRef.get().then(snap=>{
    const sel = document.getElementById("receiver");
    sel.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
    snap.forEach(u=>{
      if(u.id!==userId) sel.innerHTML+=`<option value="${u.id}">${u.data().name}</option>`;
    });
  });
});
</script>
</body>
</html>
