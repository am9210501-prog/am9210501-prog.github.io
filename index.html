<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro - Ú©Ø§Ù…Ù„</title>
<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;display:flex;}
.sidebar{width:250px;background:#111;border-right:1px solid #444;display:flex;flex-direction:column;overflow-y:auto;}
.sidebar h3{margin:5px;padding:5px;border-bottom:1px solid #444;}
.sidebar .userItem{padding:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.sidebar .userItem:hover{background:#0d6efd;}
.online-dot{width:10px;height:10px;border-radius:50%;background:#0f0;display:inline-block;margin-left:5px;}
.main{flex:1;padding:10px;display:flex;flex-direction:column;}
.chat-input{display:flex;}
.chat-input input{flex:1;padding:10px;border-radius:6px;border:none;margin-right:5px;}
.chat-input button{padding:10px;border:none;border-radius:6px;background:#00aaff;color:white;cursor:pointer;}
.messages{flex:1;overflow-y:auto;margin-bottom:5px;padding:5px;border-radius:6px;background:#111;}
.msg{background:#222;margin:5px;padding:5px;border-radius:6px;position:relative;animation:fade .3s;}
.msg .reactions span{cursor:pointer;margin-left:5px;}
.msg .reply-box{background:#333;padding:3px;font-size:12px;color:#fff3cd;margin-bottom:3px;border-radius:3px;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<div class="sidebar">
  <h3>Ú†Øª Ø®ØµÙˆØµÛŒ</h3>
  <input id="privateSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†" style="margin:5px;padding:5px;border-radius:5px;border:none;">
  <div id="privateUserList"></div>
</div>

<div class="main">
  <div id="displayNameDiv">ğŸ‘¤ <strong id="displayName"></strong> <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button></div>
  <div id="typingStatus" style="font-size:12px;color:#aaa;"></div>
  <div class="messages" id="messagesPublic"></div>
  <div class="chat-input">
    <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
    <button onclick="sendPublicMessage()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase Setup =====
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

// ===== User Setup =====
let userId = localStorage.getItem("userId");
if(!userId){ userId=Math.random().toString(36).substr(2,9); localStorage.setItem("userId",userId);}
let username = localStorage.getItem("chatName");
if(!username){ username=prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³"; localStorage.setItem("chatName",username);}
document.getElementById("displayName").innerText=username;
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload",()=>usersRef.doc(userId).update({online:false}));

// ===== Typing Status =====
document.getElementById("text").addEventListener("input", ()=>{
  typingRef.doc(userId).set({name:username});
  setTimeout(()=>typingRef.doc(userId).delete().catch(()=>{}),1500);
});
typingRef.onSnapshot(snap=>{
  let names=[];
  snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// ===== Online Users =====
let usersCache=[];
usersRef.onSnapshot(snap=>{
  usersCache=[];
  const listDiv=document.getElementById("privateUserList");
  listDiv.innerHTML="";
  snap.forEach(u=>{
    if(u.id!==userId){
      const data=u.data();
      usersCache.push({id:u.id,name:data.name,online:data.online});
    }
  });
  renderPrivateUsers(usersCache);
});

// ===== Render Private Users =====
function renderPrivateUsers(users){
  const listDiv=document.getElementById("privateUserList");
  listDiv.innerHTML="";
  users.forEach(u=>{
    const div=document.createElement("div");
    div.className="userItem";
    div.innerHTML=`<span>${u.name}</span>${u.online?'<span class="online-dot"></span>':''}`;
    div.onclick=()=>openPrivateChat(u.id,u.name);
    listDiv.appendChild(div);
  });
}

// ===== Search Private Users =====
document.getElementById("privateSearch").addEventListener("input",()=>{
  const q=document.getElementById("privateSearch").value.toLowerCase();
  const filtered=usersCache.filter(u=>u.name.toLowerCase().includes(q));
  renderPrivateUsers(filtered);
});

// ===== Private Chat Windows =====
let privateChats={};
function openPrivateChat(otherId,otherName){
  if(privateChats[otherId]) return;
  const div=document.createElement("div");
  div.className="privateChatWindow";
  div.style.bottom=Object.keys(privateChats).length*320+"px";
  div.innerHTML=`
    <div class="header">${otherName} <span style="cursor:pointer" onclick="closePrivateChat('${otherId}')">âœ–</span></div>
    <div class="messages" id="chatMsgs_${otherId}"></div>
    <input id="chatInput_${otherId}" placeholder="Ù¾ÛŒØ§Ù…...">
    <button onclick="sendPrivateMessage('${otherId}')">Ø§Ø±Ø³Ø§Ù„</button>
  `;
  document.body.appendChild(div);
  privateChats[otherId]=div;

  // Load messages
  messagesRef.orderBy("time").onSnapshot(snapshot=>{
    const box=document.getElementById(`chatMsgs_${otherId}`);
    if(!box) return;
    box.innerHTML="";
    snapshot.forEach(docSnap=>{
      const m=docSnap.data();
      if((m.userId===userId && m.receiverId===otherId) || (m.userId===otherId && m.receiverId===userId)){
        const msgDiv=document.createElement("div");
        msgDiv.className="msg";
        let replyHTML="";
        if(m.replyTo){
          const replyDoc=snapshot.docs.find(d=>d.id===m.replyTo);
          if(replyDoc) replyHTML=`<div class="reply-box">â†ª Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${replyDoc.data().name}: ${replyDoc.data().text}</div>`;
        }
        msgDiv.innerHTML=replyHTML+`${m.name}: ${m.text} ${m.seen?"âœ…":""}`;
        // Reactions
        let reactionsHTML=`<div class="reactions">
          â¤ï¸ ${m.reactions?.heart?.length||0} 
          ğŸ‘ ${m.reactions?.like?.length||0}
        </div>`;
        msgDiv.innerHTML+=reactionsHTML;

        // Delete/Edit only own messages
        if(m.userId===userId){
          const del=document.createElement("button"); del.textContent="âŒ"; del.onclick=()=>messagesRef.doc(docSnap.id).delete();
          const reply=document.createElement("button"); reply.textContent="â†©ï¸"; reply.onclick=()=>document.getElementById(`chatInput_${otherId}`).value=`â†ª ${m.text} `;
          msgDiv.appendChild(del); msgDiv.appendChild(reply);
        }
        box.appendChild(msgDiv);
        box.scrollTop=box.scrollHeight;

        // Seen
        if(m.receiverId===userId && !m.seen) messagesRef.doc(docSnap.id).update({seen:true});
      }
    });
  });
}

function closePrivateChat(otherId){
  const div=privateChats[otherId];
  if(div) div.remove();
  delete privateChats[otherId];
}

// ===== Send Private Message =====
function sendPrivateMessage(otherId){
  const input=document.getElementById(`chatInput_${otherId}`);
  const text=input.value.trim();
  if(!text) return;
  messagesRef.add({
    name:username,
    text,
    userId,
    receiverId:otherId,
    reactions:{heart:[],like:[]},
    replyTo:null,
    time:firebase.firestore.FieldValue.serverTimestamp(),
    seen:false
  });
  input.value="";
}

// ===== Public Messages =====
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  const box=document.getElementById("messagesPublic");
  box.innerHTML="";
  snapshot.forEach(docSnap=>{
    const m=docSnap.data();
    if(!m.receiverId){
      const div=document.createElement("div");
      div.className="msg";
      let replyHTML="";
      if(m.replyTo){
        const replyDoc=snapshot.docs.find(d=>d.id===m.replyTo);
        if(replyDoc) replyHTML=`<div class="reply-box">â†ª Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${replyDoc.data().name}: ${replyDoc.data().text}</div>`;
      }
      div.innerHTML=replyHTML+`${m.name}: ${m.text}`;
      // Reactions
      let reactionsHTML=`<div class="reactions">
          â¤ï¸ ${m.reactions?.heart?.length||0} 
          ğŸ‘ ${m.reactions?.like?.length||0}
      </div>`;
      div.innerHTML+=reactionsHTML;
      // Delete/Edit
      if(m.userId===userId){
        const del=document.createElement("button"); del.textContent="âŒ"; del.onclick=()=>messagesRef.doc(docSnap.id).delete();
        const reply=document.createElement("button"); reply.textContent="â†©ï¸"; reply.onclick=()=>document.getElementById("text").value=`â†ª ${m.text} `;
        div.appendChild(del); div.appendChild(reply);
      }
      box.prepend(div);
    }
  });
});

// ===== Send Public Message =====
function sendPublicMessage(){
  const text=document.getElementById("text").value.trim();
  if(!text) return alert("Ù¾ÛŒØ§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  messagesRef.add({
    name:username,
    text,
    userId,
    receiverId:null,
    reactions:{heart:[],like:[]},
    replyTo:null,
    time:firebase.firestore.FieldValue.serverTimestamp(),
    seen:false
  });
  document.getElementById("text").value="";
}

// ===== Change Name =====
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(n){
    username=n;
    localStorage.setItem("chatName",n);
    document.getElementById("displayName").innerText=n;
    usersRef.doc(userId).update({name:n});
  }
}
</script>
</body>
</html>
