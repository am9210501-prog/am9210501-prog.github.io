<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro Ù¾Ø§ÛŒØ¯Ø§Ø±</title>
<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;}
#publicView,#privateView{flex:1;display:flex;flex-direction:column;padding:10px;overflow:hidden;}
.messages{flex:1;overflow-y:auto;padding:5px;border-radius:6px;background:#111;margin-bottom:5px;}
.msg{background:#222;margin:5px;padding:5px;border-radius:6px;position:relative;animation:fade .3s;}
.msg .reactions span{cursor:pointer;margin-left:5px;}
.msg .reply-box{background:#333;padding:3px;font-size:12px;color:#fff3cd;margin-bottom:3px;border-radius:3px;}
.chat-input{display:flex;}
.chat-input input{flex:1;padding:10px;border-radius:6px;border:none;margin-right:5px;}
.chat-input button{padding:10px;border:none;border-radius:6px;background:#00aaff;color:white;cursor:pointer;}
#privateBtn,#backBtn{padding:15px;margin:5px;border:none;border-radius:8px;background:#0d6efd;color:white;font-size:16px;cursor:pointer;}
#privateBtn .unread-badge{background:red;color:white;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:5px;}
.sidebar{width:250px;background:#111;border-right:1px solid #444;display:flex;flex-direction:column;overflow-y:auto;}
.sidebar h3{margin:5px;padding:5px;border-bottom:1px solid #444;}
.sidebar .userItem{padding:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.sidebar .userItem:hover{background:#0d6efd;}
.online-dot{width:10px;height:10px;border-radius:50%;background:#0f0;display:inline-block;margin-left:5px;}
.privateChatWindow{flex:1;display:flex;flex-direction:column;}
.unread-badge{background:red;color:white;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:5px;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<!-- ==== Public View ==== -->
<div id="publicView">
  <div>ðŸ‘¤ <strong id="displayName"></strong> <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button></div>
  <div id="typingStatus" style="font-size:12px;color:#aaa;"></div>
  <div class="messages" id="messagesPublic"></div>
  <div class="chat-input">
    <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
    <button onclick="sendPublicMessage()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
  <button id="privateBtn">ðŸ’¬ Ú†Øª Ø®ØµÙˆØµÛŒ <span id="privateUnread">(0)</span></button>
</div>

<!-- ==== Private View ==== -->
<div id="privateView" style="display:none;flex:1;flex-direction:row;">
  <div class="sidebar">
    <h3>Ú†Øª Ø®ØµÙˆØµÛŒ</h3>
    <input id="privateSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†" style="margin:5px;padding:5px;border-radius:5px;border:none;">
    <div id="privateUserList"></div>
    <button id="backBtn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ</button>
  </div>
  <div class="privateChatWindow">
    <div id="privateChatContainer" style="flex:1;display:flex;flex-direction:column;">
      <div class="messages" id="privateMessages"></div>
      <div class="chat-input">
        <input id="privateText" placeholder="Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ...">
        <button onclick="sendPrivateMessage()">Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase Setup =====
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

// ===== User Setup =====
let userId = localStorage.getItem("userId");
if(!userId){ userId=Math.random().toString(36).substr(2,9); localStorage.setItem("userId",userId);}
let username = localStorage.getItem("chatName");
if(!username){ username=prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³"; localStorage.setItem("chatName",username);}
document.getElementById("displayName").innerText=username;
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload",()=>usersRef.doc(userId).update({online:false}));

// ===== Typing Status =====
document.getElementById("text").addEventListener("input", ()=>{
  typingRef.doc(userId).set({name:username});
  setTimeout(()=>typingRef.doc(userId).delete().catch(()=>{}),1500);
});
typingRef.onSnapshot(snap=>{
  let names=[];
  snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// ===== Private View Toggle =====
const publicView=document.getElementById("publicView");
const privateView=document.getElementById("privateView");
document.getElementById("privateBtn").onclick=()=>{publicView.style.display="none";privateView.style.display="flex";}
document.getElementById("backBtn").onclick=()=>{publicView.style.display="flex";privateView.style.display="none";}

// ===== Online Users & Search =====
let usersCache=[];
usersRef.onSnapshot(snap=>{
  usersCache=[];
  const listDiv=document.getElementById("privateUserList");
  listDiv.innerHTML="";
  snap.forEach(u=>{
    if(u.id!==userId){
      const data=u.data();
      usersCache.push({id:u.id,name:data.name,online:data.online});
    }
  });
  renderPrivateUsers(usersCache);
});

// ===== Unread Counter =====
let unreadPrivateCount = 0;
messagesRef.where("receiverId","==",userId).where("seen","==",false).onSnapshot(snap=>{
  unreadPrivateCount = snap.size;
  document.getElementById("privateUnread").innerText = `(${unreadPrivateCount})`;
});

// ===== Render Users Function =====
function renderPrivateUsers(users){
  const listDiv=document.getElementById("privateUserList");
  listDiv.innerHTML="";
  users.forEach(u=>{
    const div=document.createElement("div");
    div.className="userItem";
    const nameSpan=document.createElement("span"); nameSpan.textContent=u.name;
    const rightSide=document.createElement("span");
    if(u.online){const dot=document.createElement("span");dot.className="online-dot";rightSide.appendChild(dot);}
    // Count unread messages from this user
    messagesRef.where("receiverId","==",userId).where("userId","==",u.id).where("seen","==",false).get().then(snap=>{
      if(snap.size>0){
        const badge=document.createElement("span"); badge.className="unread-badge"; badge.innerText=snap.size; rightSide.appendChild(badge);
      }
    });
    div.appendChild(nameSpan); div.appendChild(rightSide);
    div.onclick=()=>selectPrivateUser(u.id,u.name);
    listDiv.appendChild(div);
  });
}

// ===== Private Chat =====
let selectedPrivateUser=null;
function selectPrivateUser(id,name){ selectedPrivateUser={id,name}; loadPrivateMessages();}
function loadPrivateMessages(){
  const box=document.getElementById("privateMessages");
  if(!selectedPrivateUser) return;
  messagesRef.orderBy("time").onSnapshot(snapshot=>{
    box.innerHTML="";
    snapshot.forEach(docSnap=>{
      const m=docSnap.data();
      if((m.userId===userId && m.receiverId===selectedPrivateUser.id) || (m.userId===selectedPrivateUser.id && m.receiverId===userId)){
        const msgDiv=document.createElement("div");
        msgDiv.className="msg";
        msgDiv.innerHTML=`${m.name}: ${m.text}`;
        // Reactions
        const reactionDiv=document.createElement("div");reactionDiv.className="reactions";
        const heart=document.createElement("span");heart.textContent=`â¤ï¸ ${m.reactions?.heart?.length||0}`;heart.style.cursor="pointer";heart.onclick=()=>toggleReaction(docSnap.id,'heart');
        const like=document.createElement("span");like.textContent=`ðŸ‘ ${m.reactions?.like?.length||0}`;like.style.cursor="pointer";like.onclick=()=>toggleReaction(docSnap.id,'like');
        reactionDiv.appendChild(heart);reactionDiv.appendChild(like);msgDiv.appendChild(reactionDiv);
        // Delete & Reply
        if(m.userId===userId){const del=document.createElement("button");del.textContent="âŒ";del.onclick=()=>messagesRef.doc(docSnap.id).delete();
          const reply=document.createElement("button");reply.textContent="â†©ï¸";reply.onclick=()=>document.getElementById("privateText").value=`â†ª ${m.text}`; msgDiv.appendChild(del); msgDiv.appendChild(reply);}
        box.appendChild(msgDiv); box.scrollTop=box.scrollHeight;
        if(m.receiverId===userId && !m.seen) messagesRef.doc(docSnap.id).update({seen:true});
      }
    });
  });
}
function sendPrivateMessage(){
  if(!selectedPrivateUser) return alert("Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  const input=document.getElementById("privateText");
  const text=input.value.trim();
  if(!text) return;
  messagesRef.add({name:username,text,userId,receiverId:selectedPrivateUser.id,reactions:{heart:[],like:[]},replyTo:null,time:firebase.firestore.FieldValue.serverTimestamp(),seen:false});
  input.value="";
}

// ===== Public Messages =====
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  const box=document.getElementById("messagesPublic"); box.innerHTML="";
  snapshot.forEach(docSnap=>{
    const m=docSnap.data();
    if(!m.receiverId){
      const div=document.createElement("div"); div.className="msg"; div.innerHTML=`${m.name}: ${m.text}`;
      const reactionDiv=document.createElement("div");reactionDiv.className="reactions";
      const heart=document.createElement("span");heart.textContent=`â¤ï¸ ${m.reactions?.heart?.length||0}`;heart.style.cursor="pointer";heart.onclick=()=>toggleReaction(docSnap.id,'heart');
      const like=document.createElement("span");like.textContent=`ðŸ‘ ${m.reactions?.like?.length||0}`;like.style.cursor="pointer";like.onclick=()=>toggleReaction(docSnap.id,'like');
      reactionDiv.appendChild(heart);reactionDiv.appendChild(like);div.appendChild(reactionDiv);
      if(m.userId===userId){const del=document.createElement("button");del.textContent="âŒ";del.onclick=()=>messagesRef.doc(docSnap.id).delete();
      const reply=document.createElement("button");reply.textContent="â†©ï¸";reply.onclick=()=>document.getElementById("text").value=`â†ª ${m.text}`;div.appendChild(del);div.appendChild(reply);}
      box.prepend(div);
    }
  });
});

// ===== Send Public Message =====
function sendPublicMessage(){
  const text=document.getElementById("text").value.trim();
  if(!text) return alert("Ù¾ÛŒØ§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  messagesRef.add({name:username,text,userId,receiverId:null,reactions:{heart:[],like:[]},replyTo:null,time:firebase.firestore.FieldValue.serverTimestamp(),seen:false});
  document.getElementById("text").value="";
}

// ===== Toggle Reactions =====
function toggleReaction(msgId,type){
  messagesRef.doc(msgId).get().then(docSnap=>{
    const data=docSnap.data();
    if(!data.reactions) data.reactions={heart:[],like:[]};
    const arr=data.reactions[type]; const idx=arr.indexOf(userId);
    if(idx===-1) arr.push(userId); else arr.splice(idx,1);
    messagesRef.doc(msgId).update({reactions:data.reactions});
  });
}

// ===== Change Name =====
function changeName(){ const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:"); if(n){ username=n; localStorage.setItem("chatName",n); document.getElementById("displayName").innerText=n; usersRef.doc(userId).update({name:n});}}

// ===== Notifications =====
if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();

</script>
</body>
</html>
