<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro</title>

<style>
body{font-family:tahoma;text-align:center;background:#0b1a2f;color:white}
.chat{max-width:600px;margin:auto;background:#111;padding:15px;border-radius:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:8px;text-align:right}
.msg-header{font-size:14px;margin-bottom:5px}
.msg-text{font-size:16px;margin-bottom:6px}
.msg-actions{display:flex;justify-content:space-between;align-items:center;margin-top:5px}
.reactions span{margin-left:8px;cursor:pointer}
input,select,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
</style>
</head>
<body>

<h2>ğŸ’¬ IRN Chat</h2>

<input id="name" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
<select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
<input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø´Ù…Ø§">
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

<div class="chat" id="messages"></div>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");

let userId = localStorage.getItem("userId");
if(!userId){
  userId = Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

// ğŸ”” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±
function saveUser(){
  const name = document.getElementById("name").value.trim();
  if(!name) return;
  usersRef.doc(userId).set({name});
}
document.getElementById("name").addEventListener("change", saveUser);

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(){
  const name = document.getElementById("name").value.trim();
  const text = document.getElementById("text").value.trim();
  const receiverId = document.getElementById("receiver").value || null;
  if(!name || !text) return alert("Ù†Ø§Ù… Ùˆ Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");

  messagesRef.add({
    name,text,userId,receiverId,
    reactions:{},
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("text").value="";
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
let firstLoad = true;

messagesRef.orderBy("time").onSnapshot(snapshot =>{
  const box = document.getElementById("messages");
  box.innerHTML="";

  snapshot.forEach(docSnap=>{
    const m = docSnap.data();

    // ÙÛŒÙ„ØªØ± Ø®ØµÙˆØµÛŒ
    if(m.receiverId && m.receiverId!==userId && m.userId!==userId) return;

    let div = document.createElement("div");
    div.className="msg";

    const timeStr = m.time ? new Date(m.time.seconds*1000).toLocaleTimeString("fa-IR") : "";

    div.innerHTML = `
      <div class="msg-header"><b>${m.name}</b> â° ${timeStr}</div>
      <div class="msg-text">${m.text}</div>
      <div class="msg-actions">
        <div class="reactions">
          <span onclick="react('${docSnap.id}','â¤ï¸')">â¤ï¸ ${m.reactions?.heart || 0}</span>
          <span onclick="react('${docSnap.id}','ğŸ‘')">ğŸ‘ ${m.reactions?.like || 0}</span>
        </div>
      </div>
    `;

    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯
    if(m.userId === userId){
      const delBtn = document.createElement("button");
      delBtn.textContent="âŒ Ø­Ø°Ù";
      delBtn.onclick=()=>messagesRef.doc(docSnap.id).delete();
      div.querySelector(".msg-actions").appendChild(delBtn);
    }

    box.appendChild(div);
  });

  // ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
  if(!firstLoad && snapshot.docChanges().length){
    const change = snapshot.docChanges()[0];
    const msg = change.doc.data();
    if(msg.userId !== userId && Notification.permission === "granted"){
      new Notification(`Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ${msg.name}`, {
        body: msg.text,
        icon: "https://cdn-icons-png.flaticon.com/512/2462/2462719.png"
      });
    }
  }

  firstLoad = false;

  // Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ
  usersRef.get().then(snap=>{
    const sel = document.getElementById("receiver");
    sel.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
    snap.forEach(u=>{
      if(u.id!==userId)
        sel.innerHTML += `<option value="${u.id}">${u.data().name}</option>`;
    });
  });
});

// ÙˆØ§Ú©Ù†Ø´â€ŒÙ‡Ø§
function react(id,type){
  const field = type === "â¤ï¸" ? "heart" : "like";
  messagesRef.doc(id).get().then(doc=>{
    const data = doc.data();
    const reactions = data.reactions || {};
    reactions[field] = (reactions[field]||0)+1;
    messagesRef.doc(id).update({reactions});
  });
}
</script>

</body>
</html>
