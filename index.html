<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;}
.top-bar{background:#0d6efd;padding:10px;color:white;display:flex;justify-content:space-between;align-items:center;font-size:14px}
.top-bar button{background:white;color:#0d6efd;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;margin-left:5px}
.chat{max-width:700px;margin:auto;padding:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px;animation:fade .3s; word-break: break-word;}
.public{border-right:4px solid #0d6efd;}
.private{border-right:4px solid #ffc107;}
.msg small{color:#aaa;font-size:12px}
.reactions span{margin-left:8px;cursor:pointer}
input,select,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
.reply-box{background:#333;padding:5px;margin-bottom:5px;border-radius:5px;font-size:12px;color:#fff3cd}
.section-title{margin-top:15px;font-weight:bold;color:#0f0}
#typingStatus,#onlineUsers{font-size:12px;color:#aaa;margin-bottom:5px}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<div class="top-bar">
  <span>ğŸ‘¤ <strong id="displayName"></strong></span>
  <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
</div>

<div class="chat">
<div id="onlineUsers"></div>
<div id="typingStatus"></div>
<div id="replyBox"></div>

<select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
<input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

<div class="section-title">ğŸ“¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</div>
<div id="publicMessages"></div>

<div class="section-title">ğŸ”’ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ</div>
<div id="privateMessages"></div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<!-- Firebase 12+ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, orderBy, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat",
  storageBucket: "irn-chat.firebasestorage.app",
  messagingSenderId: "247317938517",
  appId: "1:247317938517:web:2343d222bebb00ebd8afdc",
  measurementId: "G-W6DR1SDWS6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const messagesRef = collection(db,"messages");
const usersRef = collection(db,"users");

/* ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± */
let userId = localStorage.getItem("userId") || Math.random().toString(36).substr(2,9);
localStorage.setItem("userId", userId);

let username = localStorage.getItem("chatName") || prompt("Ù†Ø§Ù… Ø´Ù…Ø§ØŸ") || "Ú©Ø§Ø±Ø¨Ø±";
localStorage.setItem("chatName", username);
document.getElementById("displayName").innerText = username;

setDoc(doc(usersRef,userId), {name:username, online:true}, {merge:true});
window.addEventListener("beforeunload", ()=>setDoc(doc(usersRef,userId), {online:false}, {merge:true}));

/* âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… */
let replyTo=null;
async function sendMessage(){
  const textEl = document.getElementById("text");
  const text=textEl.value.trim();
  const receiverId=document.getElementById("receiver").value||null;
  if(!text) return alert("Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");

  await addDoc(messagesRef, {
    name:username,
    text,
    userId,
    receiverId,
    replyTo,
    time: serverTimestamp()
  });

  textEl.value="";
  replyTo=null;
  document.getElementById("replyBox").innerText="";
}

/* ğŸ“© Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
const q = query(messagesRef, orderBy("time"));
onSnapshot(q, snapshot=>{
  const pub = document.getElementById("publicMessages");
  const pri = document.getElementById("privateMessages");
  pub.innerHTML="";
  pri.innerHTML="";

  snapshot.docs.forEach(docSnap=>{
    const m = docSnap.data();
    const div = document.createElement("div");
    div.className = "msg "+(m.receiverId?"private":"public");
    const timeStr = m.time ? new Date(m.time.seconds*1000).toLocaleTimeString("fa-IR") : "";
    div.innerHTML=`<b>${m.name}</b> â° ${timeStr}<br>${m.text}`;

    if(m.receiverId){
      if(m.userId===userId || m.receiverId===userId) pri.prepend(div);
    } else {
      pub.prepend(div);
    }
  });
});

/* Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† */
async function updateUsers(){
  const sel = document.getElementById("receiver");
  sel.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
  const snap = await getDocs(usersRef);
  snap.forEach(u=>{
    if(u.id!==userId) sel.innerHTML+=`<option value="${u.id}">${u.data().name}</option>`;
  });
}
setInterval(updateUsers,2000);

/* ØªØºÛŒÛŒØ± Ù†Ø§Ù… */
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(n){
    username=n;
    localStorage.setItem("chatName",n);
    document.getElementById("displayName").innerText=n;
    setDoc(doc(usersRef,userId), {name:n}, {merge:true});
  }
}

/* ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
if ("Notification" in window && Notification.permission!=="granted"){
  Notification.requestPermission();
}

/* ğŸ”§ Service Worker */
if ("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
