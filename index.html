<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro</title>

<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0}
.top-bar{background:#0d6efd;padding:10px;display:flex;justify-content:space-between}
.chat{max-width:700px;margin:auto;padding:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px}
#messagesPublic,#messagesPrivate{max-height:300px;overflow:auto;margin-bottom:10px;padding:5px}
#messagesPublic{background:#111}
#messagesPrivate{background:#222}
.reply-box{background:#333;padding:5px;margin-bottom:5px;border-radius:5px;color:#fff3cd}
</style>
</head>

<body>

<div class="top-bar">
  ğŸ‘¤ <strong id="displayName"></strong>
  <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
</div>

<div class="chat">
  <div id="onlineUsers"></div>
  <div id="typingStatus"></div>
  <div id="replyBox"></div>

  <input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
  <select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
  <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
  <div id="messagesPublic"></div>

  <h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ</h3>
  <div id="messagesPrivate"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain:"irn-chat.firebaseapp.com",
  projectId:"irn-chat"
};
firebase.initializeApp(firebaseConfig);

const db=firebase.firestore();
const messagesRef=db.collection("messages");
const usersRef=db.collection("users");

let userId=localStorage.getItem("userId")||Math.random().toString(36).substr(2,9);
localStorage.setItem("userId",userId);

let username=localStorage.getItem("chatName");
if(!username){
  username=prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯")||"Ú©Ø§Ø±Ø¨Ø±";
  localStorage.setItem("chatName",username);
}
displayName.innerText=username;

let lastMessageTime=0;

// Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±
usersRef.doc(userId).set({
  name:username,
  online:true,
  lastSeen:Date.now()
});

// Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÙˆØ¬
window.addEventListener("beforeunload",()=>{
  usersRef.doc(userId).update({
    online:false,
    lastSeen:Date.now()
  });
});

// Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter
text.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// Ù†Ù…Ø§ÛŒØ´ Ø¢Ù†Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§ + Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯
usersRef.onSnapshot(snap=>{
  let html="Ø¢Ù†Ù„Ø§ÛŒÙ†:<br>";
  receiver.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';

  snap.forEach(doc=>{
    const u=doc.data();
    const lastSeen=u.lastSeen?Math.floor((Date.now()-u.lastSeen)/60000):0;
    const status=u.online?"ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†":`â± ${lastSeen} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´`;

    html+=`${u.name} (${status})<br>`;

    if(doc.id!==userId)
      receiver.innerHTML+=`<option value="${doc.id}">${u.name}</option>`;
  });

  onlineUsers.innerHTML=html;
});

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(){
  const textMsg=text.value.trim();
  const receiverId=receiver.value||null;

  if(!textMsg) return;

  // Ø¶Ø¯ Ø§Ø³Ù¾Ù…
  if(Date.now()-lastMessageTime<2000){
    alert("Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯");
    return;
  }
  lastMessageTime=Date.now();

  messagesRef.add({
    name:username,
    text:textMsg,
    userId,
    receiverId,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });

  text.value="";
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  messagesPublic.innerHTML="";
  messagesPrivate.innerHTML="";

  snapshot.forEach(doc=>{
    const m=doc.data();
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML=`<b>${m.name}</b><br>${m.text}`;

    if(m.receiverId){
      if(m.userId===userId||m.receiverId===userId)
        messagesPrivate.prepend(div);
    }else{
      messagesPublic.prepend(div);
    }
  });
});

// ØªØºÛŒÛŒØ± Ù†Ø§Ù…
function changeName(){
  const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:");
  if(!n) return;
  username=n;
  localStorage.setItem("chatName",n);
  displayName.innerText=n;
  usersRef.doc(userId).update({name:n});
}
</script>
</body>
  </html>
