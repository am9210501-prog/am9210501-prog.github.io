<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;}
.top-bar{background:#0d6efd;padding:10px;display:flex;justify-content:space-between}
.chat{max-width:700px;margin:auto;padding:10px}
.msg{background:#222;margin:8px;padding:10px;border-radius:10px}
#messagesPublic,#messagesPrivate{max-height:300px;overflow:auto;padding:5px;border-radius:5px;margin-bottom:10px}
#messagesPublic{background:#111}
#messagesPrivate{background:#222}
</style>
</head>
<body>

<div class="top-bar">
ðŸ‘¤ <strong id="displayName"></strong>
</div>

<div class="chat">
<input id="text" placeholder="Ù¾ÛŒØ§Ù…...">
<select id="receiver"><option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option></select>
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

<h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
<div id="messagesPublic"></div>

<h3>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ</h3>
<div id="messagesPrivate"></div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
/* ðŸ”” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ± */
if ("Notification" in window) {
  Notification.requestPermission();
}

/* ðŸ”§ Ø«Ø¨Øª Service Worker */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

/* ðŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");

let userId = localStorage.getItem("userId") || Math.random().toString(36).substr(2,9);
localStorage.setItem("userId", userId);

let username = localStorage.getItem("chatName") || prompt("Ù†Ø§Ù… Ø´Ù…Ø§ØŸ") || "Ù†Ø§Ø´Ù†Ø§Ø³";
localStorage.setItem("chatName", username);
displayName.innerText = username;

usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload", ()=>usersRef.doc(userId).update({online:false}));

function sendMessage(){
  const text=textInput.value.trim();
  const receiverId=receiver.value||null;
  if(!text) return;

  messagesRef.add({name:username,text,userId,receiverId,time:firebase.firestore.FieldValue.serverTimestamp()});
  textInput.value="";
}

const textInput=document.getElementById("text");
const receiver=document.getElementById("receiver");

messagesRef.orderBy("time").onSnapshot(snapshot=>{
  messagesPublic.innerHTML="";
  messagesPrivate.innerHTML="";

  snapshot.forEach(doc=>{
    const m=doc.data();
    const div=document.createElement("div");
    div.className="msg";
    div.textContent=m.name+" : "+m.text;

    if(m.receiverId){
      if(m.userId===userId || m.receiverId===userId) messagesPrivate.prepend(div);
    } else {
      messagesPublic.prepend(div);
    }
  });

  usersRef.get().then(snap=>{
    receiver.innerHTML='<option value="">Ø¹Ù…ÙˆÙ…ÛŒ</option>';
    snap.forEach(u=>{if(u.id!==userId) receiver.innerHTML+=<option value="${u.id}">${u.data().name}</option>;});
  });
});
</script>
</body>
</html>
