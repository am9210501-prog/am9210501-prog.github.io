<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat Pro - Ù¾Ø§ÛŒØ¯Ø§Ø±</title>
<style>
body{font-family:tahoma;background:#0b1a2f;color:white;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;}
#publicView,#privateView{flex:1;display:flex;flex-direction:column;padding:10px;overflow:hidden;}
.messages{flex:1;overflow-y:auto;padding:5px;border-radius:6px;background:#111;margin-bottom:5px;}
.msg{background:#222;margin:5px;padding:5px;border-radius:6px;position:relative;animation:fade .3s;}
.msg .reactions span{cursor:pointer;margin-left:5px;}
.msg .reply-box{background:#333;padding:3px;font-size:12px;color:#fff3cd;margin-bottom:3px;border-radius:3px;}
.chat-input{display:flex;}
.chat-input input{flex:1;padding:10px;border-radius:6px;border:none;margin-right:5px;}
.chat-input button{padding:10px;border:none;border-radius:6px;background:#00aaff;color:white;cursor:pointer;}
#privateBtn,#backBtn{padding:15px;margin:5px;border:none;border-radius:8px;background:#0d6efd;color:white;font-size:16px;cursor:pointer;}
.sidebar{width:250px;background:#111;border-right:1px solid #444;display:flex;flex-direction:column;overflow-y:auto;}
.sidebar h3{margin:5px;padding:5px;border-bottom:1px solid #444;}
.sidebar .userItem{padding:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.sidebar .userItem:hover{background:#0d6efd;}
.online-dot{width:10px;height:10px;border-radius:50%;background:#0f0;display:inline-block;margin-left:5px;}
.privateChatWindow{flex:1;display:flex;flex-direction:column;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
</style>
</head>
<body>

<!-- Public View -->
<div id="publicView">
  <div>ðŸ‘¤ <strong id="displayName"></strong> <button onclick="changeName()">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button></div>
  <div id="typingStatus" style="font-size:12px;color:#aaa;"></div>
  <div class="messages" id="messagesPublic"></div>
  <div class="chat-input">
    <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
    <button onclick="sendPublicMessage()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
  <button id="privateBtn">ðŸ’¬ Ú†Øª Ø®ØµÙˆØµÛŒ</button>
</div>

<!-- Private View -->
<div id="privateView" style="display:none;flex:1;flex-direction:row;">
  <div class="sidebar">
    <h3>Ú†Øª Ø®ØµÙˆØµÛŒ</h3>
    <input id="privateSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†" style="margin:5px;padding:5px;border-radius:5px;border:none;">
    <div id="privateUserList"></div>
    <button id="backBtn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ</button>
  </div>
  <div class="privateChatWindow">
    <div id="privateChatContainer" style="flex:1;display:flex;flex-direction:column;">
      <div class="messages" id="privateMessages"></div>
      <div class="chat-input">
        <input id="privateText" placeholder="Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ...">
        <button onclick="sendPrivateMessage()">Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple-02.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase Setup =====
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesRef = db.collection("messages");
const usersRef = db.collection("users");
const typingRef = db.collection("typing");

// ===== User Setup =====
let userId = localStorage.getItem("userId");
if(!userId){ userId=Math.random().toString(36).substr(2,9); localStorage.setItem("userId",userId);}
let username = localStorage.getItem("chatName");
if(!username){ username=prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯") || "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³"; localStorage.setItem("chatName",username);}
document.getElementById("displayName").innerText=username;
usersRef.doc(userId).set({name:username, online:true});
window.addEventListener("beforeunload",()=>usersRef.doc(userId).update({online:false}));

// ===== Typing Status =====
document.getElementById("text").addEventListener("input", ()=>{ typingRef.doc(userId).set({name:username}); setTimeout(()=>typingRef.doc(userId).delete().catch(()=>{}),1500); });
typingRef.onSnapshot(snap=>{
  let names=[]; snap.forEach(d=>{ if(d.id!==userId) names.push(d.data().name) });
  document.getElementById("typingStatus").innerText = names.length?names.join(" Ùˆ ")+" Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...":"";
});

// ===== Public / Private Toggle =====
const publicView=document.getElementById("publicView");
const privateView=document.getElementById("privateView");
document.getElementById("privateBtn").onclick=()=>{ publicView.style.display="none"; privateView.style.display="flex"; }
document.getElementById("backBtn").onclick=()=>{ publicView.style.display="flex"; privateView.style.display="none"; }

// ===== Online Users & Search =====
let usersCache=[];
usersRef.onSnapshot(snap=>{
  usersCache=[];
  const listDiv=document.getElementById("privateUserList"); listDiv.innerHTML="";
  snap.forEach(u=>{ if(u.id!==userId){ const data=u.data(); usersCache.push({id:u.id,name:data.name,online:data.online}); } });
  renderPrivateUsers(usersCache);
});
function renderPrivateUsers(users){ const listDiv=document.getElementById("privateUserList"); listDiv.innerHTML=""; users.forEach(u=>{ const div=document.createElement("div"); div.className="userItem"; div.innerHTML=`<span>${u.name}</span>${u.online?'<span class="online-dot"></span>':''}`; div.onclick=()=>selectPrivateUser(u.id,u.name); listDiv.appendChild(div); }); }
document.getElementById("privateSearch").addEventListener("input",()=>{ const q=document.getElementById("privateSearch").value.toLowerCase(); const filtered=usersCache.filter(u=>u.name.toLowerCase().includes(q)); renderPrivateUsers(filtered); });

// ===== Manage Rendered Messages =====
let renderedPublicMessages = new Map();
let renderedPrivateMessages = new Map();

// ===== Public Messages =====
let replyToPublic=null;
messagesRef.orderBy("time").onSnapshot(snapshot=>{
  snapshot.docChanges().forEach(change=>{
    const m = change.doc.data();
    const mid = change.doc.id;
    if(!m.receiverId && !renderedPublicMessages.has(mid)){
      renderedPublicMessages.set(mid,true);
      const box = document.getElementById("messagesPublic");
      const msgDiv = document.createElement("div"); msgDiv.className="msg";
      // Reply
      let replyHTML="";
      if(m.replyTo){
        const replyDoc=snapshot.docs.find(d=>d.id===m.replyTo);
        if(replyDoc) replyHTML=`<div class="reply-box">â†ª Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${replyDoc.data().name}: ${replyDoc.data().text}</div>`;
      }
      msgDiv.innerHTML = replyHTML+`${m.name}: ${m.text}`;
      // Reactions
      const reactionDiv = document.createElement("div"); reactionDiv.className="reactions";
      const heart = document.createElement("span"); heart.textContent=`â¤ï¸ ${m.reactions?.heart?.length||0}`; heart.onclick=()=>toggleReaction(mid,"heart");
      const like = document.createElement("span"); like.textContent=`ðŸ‘ ${m.reactions?.like?.length||0}`; like.onclick=()=>toggleReaction(mid,"like");
      reactionDiv.appendChild(heart); reactionDiv.appendChild(like);
      msgDiv.appendChild(reactionDiv);
      // Delete/Edit/Reply
      if(m.userId===userId){
        const del=document.createElement("button"); del.textContent="âŒ"; del.onclick=()=>messagesRef.doc(mid).delete();
        const edit=document.createElement("button"); edit.textContent="âœï¸"; edit.onclick=()=>{ const t=prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…:",m.text); if(t) messagesRef.doc(mid).update({text:t}); }
        const replyBtn=document.createElement("button"); replyBtn.textContent="â†©ï¸"; replyBtn.onclick=()=>{replyToPublic=mid; document.getElementById("text").value=`â†ª ${m.text} `;}
        msgDiv.appendChild(del); msgDiv.appendChild(edit); msgDiv.appendChild(replyBtn);
      }
      box.appendChild(msgDiv);
      box.scrollTop=box.scrollHeight;
      if(m.userId!==userId){ document.getElementById("notifSound").play(); if(Notification.permission==="granted") new Notification(`Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ${m.name}`,{body:m.text}); }
    }
  });
});

// ===== Send Public Message =====
function sendPublicMessage(){
  const input=document.getElementById("text"); const text=input.value.trim(); if(!text) return alert("Ù¾ÛŒØ§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  messagesRef.add({name:username,text,userId,receiverId:null,reactions:{heart:[],like:[]},replyTo:replyToPublic,time:firebase.firestore.FieldValue.serverTimestamp(),seen:false});
  input.value=""; replyToPublic=null;
}

// ===== Private Chat =====
let selectedPrivateUser=null; let replyToPrivate=null;
function selectPrivateUser(id,name){ selectedPrivateUser={id,name}; loadPrivateMessages(); }
function loadPrivateMessages(){
  if(!selectedPrivateUser) return;
  const box=document.getElementById("privateMessages"); box.innerHTML="";
  renderedPrivateMessages = new Map();
  messagesRef.orderBy("time").onSnapshot(snapshot=>{
    snapshot.docChanges().forEach(change=>{
      const m=change.doc.data(); const mid=change.doc.id;
      if((m.userId===userId && m.receiverId===selectedPrivateUser.id) || (m.userId===selectedPrivateUser.id && m.receiverId===userId)){
        if(renderedPrivateMessages.has(mid)) return;
        renderedPrivateMessages.set(mid,true);
        const msgDiv=document.createElement("div"); msgDiv.className="msg";
        // Reply
        let replyHTML="";
        if(m.replyTo){
          const replyDoc=snapshot.docs.find(d=>d.id===m.replyTo);
          if(replyDoc) replyHTML=`<div class="reply-box">â†ª Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${replyDoc.data().name}: ${replyDoc.data().text}</div>`;
        }
        msgDiv.innerHTML = replyHTML+`${m.name}: ${m.text} ${m.seen?"âœ…":""}`;
        // Reactions
        const reactionDiv = document.createElement("div"); reactionDiv.className="reactions";
        const heart = document.createElement("span"); heart.textContent=`â¤ï¸ ${m.reactions?.heart?.length||0}`; heart.onclick=()=>toggleReaction(mid,"heart");
        const like = document.createElement("span"); like.textContent=`ðŸ‘ ${m.reactions?.like?.length||0}`; like.onclick=()=>toggleReaction(mid,"like");
        reactionDiv.appendChild(heart); reactionDiv.appendChild(like);
        msgDiv.appendChild(reactionDiv);
        // Delete/Edit/Reply
        if(m.userId===userId){
          const del=document.createElement("button"); del.textContent="âŒ"; del.onclick=()=>messagesRef.doc(mid).delete();
          const edit=document.createElement("button"); edit.textContent="âœï¸"; edit.onclick=()=>{ const t=prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…:",m.text); if(t) messagesRef.doc(mid).update({text:t}); }
          const replyBtn=document.createElement("button"); replyBtn.textContent="â†©ï¸"; replyBtn.onclick=()=>{replyToPrivate=mid; document.getElementById("privateText").value=`â†ª ${m.text} `;}
          msgDiv.appendChild(del); msgDiv.appendChild(edit); msgDiv.appendChild(replyBtn);
        }
        box.appendChild(msgDiv); box.scrollTop=box.scrollHeight;
        if(m.receiverId===userId && !m.seen) messagesRef.doc(mid).update({seen:true});
        if(m.userId!==userId){ document.getElementById("notifSound").play(); if(Notification.permission==="granted") new Notification(`Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ${m.name}`,{body:m.text}); }
      }
    });
  });
}

function sendPrivateMessage(){
  if(!selectedPrivateUser) return alert("Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  const input=document.getElementById("privateText"); const text=input.value.trim(); if(!text) return;
  messagesRef.add({name:username,text,userId,receiverId:selectedPrivateUser.id,reactions:{heart:[],like:[]},replyTo:replyToPrivate,time:firebase.firestore.FieldValue.serverTimestamp(),seen:false});
  input.value=""; replyToPrivate=null;
}

// ===== Reaction Toggle =====
function toggleReaction(msgId,type){
  messagesRef.doc(msgId).get().then(docSnap=>{
    const data=docSnap.data();
    if(!data.reactions) data.reactions={heart:[],like:[]};
    const arr=data.reactions[type];
    const idx=arr.indexOf(userId);
    if(idx===-1) arr.push(userId); else arr.splice(idx,1);
    messagesRef.doc(msgId).update({reactions:data.reactions});
  });
}

// ===== Change Name =====
function changeName(){ const n=prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:"); if(n){ username=n; localStorage.setItem("chatName",n); document.getElementById("displayName").innerText=n; usersRef.doc(userId).update({name:n}); } }

// ===== Notification Permission =====
if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();

</script>
</body>
      </html>
