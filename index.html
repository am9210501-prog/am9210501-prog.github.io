<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRN Chat</title>
<style>
body{font-family:tahoma;text-align:center;background:#0b1a2f;color:white}
.chat{max-width:500px;margin:auto;background:#111;padding:15px;border-radius:10px}
.msg{background:#222;margin:5px;padding:8px;border-radius:6px;text-align:right;position:relative}
.msg button{position:absolute;left:5px;top:5px;background:red;color:white;border:none;border-radius:4px;cursor:pointer;padding:2px 5px;}
input,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#00aaff;color:white;cursor:pointer}
</style>
</head>
<body>

<h2>ðŸ’¬ Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† IRN</h2>

<div class="chat">
<input id="name" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
<input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø´Ù…Ø§">
<button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>

<div id="messages"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQdlikBbxE0_U_meQ2PiNas3dlt6-OvPA",
  authDomain: "irn-chat.firebaseapp.com",
  projectId: "irn-chat",
  storageBucket: "irn-chat.firebasestorage.app",
  messagingSenderId: "247317938517",
  appId: "1:247317938517:web:2343d222bebb00ebd8afdc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const messagesRef = collection(db, "messages");

// Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ØŒ uid Ù…ÙˆÙ‚Øª Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… (Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯)
let userId = localStorage.getItem("userId");
if(!userId) {
  userId = Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

window.sendMessage = async function() {
  const name = document.getElementById("name").value.trim();
  const text = document.getElementById("text").value.trim();
  if(!name || !text) return alert("Ù†Ø§Ù… Ùˆ Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");

  await addDoc(messagesRef, {
    name,
    text,
    userId,
    time: new Date()
  });

  document.getElementById("text").value="";
};

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
const q = query(messagesRef, orderBy("time"));

onSnapshot(q, snapshot => {
  const box = document.getElementById("messages");
  box.innerHTML="";
  snapshot.forEach(docSnap => {
    const m = docSnap.data();
    const div = document.createElement("div");
    div.className="msg";
    div.innerHTML=`<b>${m.name}:</b> ${m.text}`;
    
    // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    if(m.userId === userId){
      const delBtn = document.createElement("button");
      delBtn.innerText = "âŒ";
      delBtn.onclick = async ()=>{
        await deleteDoc(doc(db,"messages",docSnap.id));
      };
      div.appendChild(delBtn);
    }

    box.appendChild(div);
  });
});
</script>

</body>
</html>
